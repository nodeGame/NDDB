<!DOCTYPE html>
<html>
<head>
  <title>fs.js</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <link rel="stylesheet" media="all" href="../doc-style.css" />
  <script src="../doc-filelist.js"></script>
  <script>
    var relativeDir = '../', thisFile = 'lib/fs.js', defaultSidebar = true;
  </script>
  <script src="../doc-script.js"></script>
</head>
<body>
  <div id="sidebar_wrapper">
    <div id="sidebar_switch">
      <span class="tree">Files</span>
      <span class="headings">Headings</span>
    </div>
    <div id="tree"></div>
    <div id="headings">
      <div class="heading h1">
        <a href="#nddb--fs.js">NDDB: fs.js</a>
      </div>
      <div class="heading h3">
        <a href="#nddb.storageavailable">NDDB.storageAvailable</a>
      </div>
      <div class="heading h3">
        <a href="#nddb.adddefaultformats">NDDB.addDefaultFormats</a>
      </div>
      <div class="heading h2">
        <a href="#helper-methods">Helper Methods</a>
      </div>
      <div class="heading h3">
        <a href="#loadcsv">loadCsv</a>
      </div>
      <div class="heading h3">
        <a href="#savecsv">saveCsv</a>
      </div>
      <div class="heading h3">
        <a href="#setdefaultcsvoptions">setDefaultCsvOptions</a>
      </div>
      <div class="heading h3">
        <a href="#getcsvheaders">getCsvHeaders</a>
      </div>
      <div class="heading h3">
        <a href="#getcsvrow">getCsvRow</a>
      </div>
      <div class="heading h3">
        <a href="#parsecsvtoken">parseCsvToken</a>
      </div>
      <div class="heading h3">
        <a href="#createcsvtoken">createCsvToken</a>
      </div>
      <div class="heading h3">
        <a href="#loadcb">loadCb</a>
      </div>
      <div class="heading h3">
        <a href="#streamingread">streamingRead</a>
      </div>
      <div class="heading h3">
        <a href="#streamingreadsync">streamingReadSync</a>
      </div>
      <div class="heading h3">
        <a href="#streamingwrite">streamingWrite</a>
      </div>
      <div class="heading h3">
        <a href="#streamingwritesync">streamingWriteSync</a>
      </div>
      <div class="heading h3">
        <a href="#processfilestreaminsync">processFileStreamInSync</a>
      </div>
      <div class="heading h3">
        <a href="#processfilestreamoutsync">processFileStreamOutSync</a>
      </div>
    </div>
  </div>
  <div id="sidebar-toggle"></div>
  <div id="container"><div class="background highlight"></div>
<table cellpadding="0" cellspacing="0">
  <tbody>
      <tr>
        <td class="docs"><div class="dox">
  <div class="summary">
<div class="pilwrap" id="nddb--fs.js">
  <h1>
    <a href="#nddb--fs.js" class="pilcrow">&#182;</a>
    NDDB: fs.js
  </h1>
</div>


<p>Copyright(c) 2015 Stefano Balietti
MIT Licensed.</p>
  </div>
  <div class="body"><p>NDDB file systems routines to save and load items</p>

<p>Overrides save and load methods available in browser, with methods that
use the Node.JS fs api.</p>

<p>Cyclic objects are decycled, and do not cause errors.
Upon loading, the cycles are restored.</p>
  </div>
  <div class="details">
    <div class="dox_tag_title">See</div>
    <div class="dox_tag_detail">
      <span class="dox_type">fs.writeFile</span>
    </div>
    <div class="dox_tag_title">See</div>
    <div class="dox_tag_detail">
      <span class="dox_type">fs.writeFileSync</span>
    </div>
    <div class="dox_tag_title">See</div>
    <div class="dox_tag_detail">
      <span class="dox_type">fs.readFile</span>
    </div>
    <div class="dox_tag_title">See</div>
    <div class="dox_tag_detail">
      <span class="dox_type">fs.readFileSync
</span>
    </div>
    <div class="dox_tag_title">See</div>
    <div class="dox_tag_detail">
      <span class="dox_type">JSUS.parse</span>
    </div>
    <div class="dox_tag_title">See</div>
    <div class="dox_tag_detail">
      <span class="dox_type">NDDB.stringify</span>
    </div>
    <div class="dox_tag_title">See</div>
    <div class="dox_tag_detail">
      <a href=" ">https://github.com/douglascrockford/JSON-js/blob/master/cycle.js

---
</a>
    </div>
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>

    <span class="s1">&#39;use strict&#39;</span><span class="p">;</span>

    <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;../external/cycle.js&#39;</span><span class="p">);</span>

    <span class="kd">var</span> <span class="nx">fs</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;fs&#39;</span><span class="p">);</span>

    <span class="kd">var</span> <span class="nx">J</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;JSUS&#39;</span><span class="p">).</span><span class="nx">JSUS</span><span class="p">;</span>

    <span class="kd">var</span> <span class="nx">NDDB</span> <span class="o">=</span> <span class="nx">module</span><span class="p">.</span><span class="nx">parent</span><span class="p">.</span><span class="nx">exports</span><span class="p">.</span><span class="nx">NDDB</span><span class="p">;</span></pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs"><div class="dox">
  <div class="summary">
<div class="pilwrap" id="nddb.storageavailable">
  <h3>
    <a href="#nddb.storageavailable" class="pilcrow">&#182;</a>
    NDDB.storageAvailable
  </h3>
</div>

  </div>
  <div class="body"><p>Dummy function that returns always true</p>

<p>Overrides default storageAvailable method for the browser.</p>
  </div>
  <div class="details">
    <div class="dox_tag_title">Returns</div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name"></span>
      <span class="dox_type">boolean</span>
      <span>true</span>
    </div>
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre>    <span class="nx">NDDB</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">storageAvailable</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>
    <span class="p">};</span></pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs"><div class="dox">
  <div class="summary">
<div class="pilwrap" id="nddb.adddefaultformats">
  <h3>
    <a href="#nddb.adddefaultformats" class="pilcrow">&#182;</a>
    NDDB.addDefaultFormats
  </h3>
</div>

  </div>
  <div class="body"><p>Dummy function that returns always true</p>

<p>Overrides default storageAvailable method for the browser.</p>
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre>    <span class="nx">NDDB</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">addDefaultFormats</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>

        <span class="k">this</span><span class="p">.</span><span class="nx">__formats</span><span class="p">.</span><span class="nx">json</span> <span class="o">=</span> <span class="p">{</span></pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-4" id="section-4">&#182;</a>
</div>
<p>Async.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>            <span class="nx">load</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">that</span><span class="p">,</span> <span class="nx">file</span><span class="p">,</span> <span class="nx">cb</span><span class="p">,</span> <span class="nx">options</span><span class="p">)</span> <span class="p">{</span>
                <span class="nx">fs</span><span class="p">.</span><span class="nx">readFile</span><span class="p">(</span><span class="nx">file</span><span class="p">,</span> <span class="nx">options</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
                    <span class="k">if</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="nx">that</span><span class="p">.</span><span class="nx">throwErr</span><span class="p">(</span><span class="s1">&#39;Error&#39;</span><span class="p">,</span> <span class="s1">&#39;load&#39;</span><span class="p">,</span> <span class="nx">err</span><span class="p">);</span>
                    <span class="nx">loadCb</span><span class="p">(</span><span class="nx">that</span><span class="p">,</span> <span class="nx">data</span><span class="p">);</span>
                    <span class="k">if</span> <span class="p">(</span><span class="nx">cb</span><span class="p">)</span> <span class="nx">cb</span><span class="p">();</span>
                <span class="p">});</span>
            <span class="p">},</span>
            <span class="nx">save</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">that</span><span class="p">,</span> <span class="nx">file</span><span class="p">,</span> <span class="nx">cb</span><span class="p">,</span> <span class="nx">options</span><span class="p">)</span> <span class="p">{</span>
                <span class="nx">fs</span><span class="p">.</span><span class="nx">writeFile</span><span class="p">(</span><span class="nx">file</span><span class="p">,</span> <span class="nx">that</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="o">!!</span><span class="nx">options</span><span class="p">.</span><span class="nx">compress</span><span class="p">),</span>
                             <span class="nx">options</span><span class="p">,</span> <span class="nx">cb</span><span class="p">);</span>
            <span class="p">},</span></pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-5" id="section-5">&#182;</a>
</div>
<p>Sync.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>            <span class="nx">loadSync</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">that</span><span class="p">,</span> <span class="nx">file</span><span class="p">,</span> <span class="nx">cb</span><span class="p">,</span> <span class="nx">options</span><span class="p">)</span> <span class="p">{</span>
                <span class="nx">loadCb</span><span class="p">(</span><span class="nx">that</span><span class="p">,</span> <span class="nx">fs</span><span class="p">.</span><span class="nx">readFileSync</span><span class="p">(</span><span class="nx">file</span><span class="p">,</span> <span class="nx">options</span><span class="p">));</span>
                <span class="k">if</span> <span class="p">(</span><span class="nx">cb</span><span class="p">)</span> <span class="nx">cb</span><span class="p">();</span>
            <span class="p">},</span>
            <span class="nx">saveSync</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">that</span><span class="p">,</span> <span class="nx">file</span><span class="p">,</span> <span class="nx">cb</span><span class="p">,</span> <span class="nx">options</span><span class="p">)</span> <span class="p">{</span>
                <span class="nx">fs</span><span class="p">.</span><span class="nx">writeFileSync</span><span class="p">(</span><span class="nx">file</span><span class="p">,</span> <span class="nx">that</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="o">!!</span><span class="nx">options</span><span class="p">.</span><span class="nx">compress</span><span class="p">),</span>
                                 <span class="nx">options</span><span class="p">);</span>

                <span class="k">if</span> <span class="p">(</span><span class="nx">cb</span><span class="p">)</span> <span class="nx">cb</span><span class="p">();</span>
            <span class="p">}</span>
        <span class="p">};</span>

        <span class="k">this</span><span class="p">.</span><span class="nx">__formats</span><span class="p">.</span><span class="nx">csv</span> <span class="o">=</span> <span class="p">{</span></pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-6" id="section-6">&#182;</a>
</div>
<p>Async.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>            <span class="nx">load</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">that</span><span class="p">,</span> <span class="nx">file</span><span class="p">,</span> <span class="nx">cb</span><span class="p">,</span> <span class="nx">options</span><span class="p">)</span> <span class="p">{</span>
                <span class="nx">loadCsv</span><span class="p">(</span><span class="nx">that</span><span class="p">,</span> <span class="nx">file</span><span class="p">,</span> <span class="nx">streamingRead</span><span class="p">,</span> <span class="nx">cb</span><span class="p">,</span> <span class="nx">options</span><span class="p">,</span><span class="s1">&#39;load&#39;</span><span class="p">,</span>
                <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
                    <span class="k">if</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="nx">that</span><span class="p">.</span><span class="nx">throwErr</span><span class="p">(</span><span class="s1">&#39;Error&#39;</span><span class="p">,</span> <span class="s1">&#39;load&#39;</span><span class="p">,</span> <span class="nx">err</span><span class="p">);</span>
                <span class="p">});</span>
            <span class="p">},</span>
            <span class="nx">save</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">that</span><span class="p">,</span> <span class="nx">file</span><span class="p">,</span> <span class="nx">cb</span><span class="p">,</span> <span class="nx">options</span><span class="p">)</span> <span class="p">{</span>
                <span class="nx">saveCsv</span><span class="p">(</span><span class="nx">that</span><span class="p">,</span> <span class="nx">file</span><span class="p">,</span> <span class="nx">streamingWrite</span><span class="p">,</span> <span class="nx">cb</span><span class="p">,</span> <span class="nx">options</span><span class="p">,</span>
                    <span class="s1">&#39;save&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
                        <span class="k">if</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="nx">that</span><span class="p">.</span><span class="nx">throwErr</span><span class="p">(</span><span class="s1">&#39;Error&#39;</span><span class="p">,</span> <span class="s1">&#39;save&#39;</span><span class="p">,</span> <span class="nx">err</span><span class="p">);</span>
                    <span class="p">}</span>
                <span class="p">);</span>
            <span class="p">},</span></pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-7" id="section-7">&#182;</a>
</div>
<p>Sync.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>            <span class="nx">loadSync</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">that</span><span class="p">,</span> <span class="nx">file</span><span class="p">,</span> <span class="nx">cb</span><span class="p">,</span> <span class="nx">options</span><span class="p">)</span> <span class="p">{</span>
                <span class="nx">loadCsv</span><span class="p">(</span><span class="nx">that</span><span class="p">,</span> <span class="nx">file</span><span class="p">,</span> <span class="nx">streamingReadSync</span><span class="p">,</span> <span class="nx">cb</span><span class="p">,</span> <span class="nx">options</span><span class="p">,</span>
                    <span class="s1">&#39;loadSync&#39;</span>
                <span class="p">);</span>
            <span class="p">},</span>
            <span class="nx">saveSync</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">that</span><span class="p">,</span> <span class="nx">file</span><span class="p">,</span> <span class="nx">cb</span><span class="p">,</span> <span class="nx">options</span><span class="p">)</span> <span class="p">{</span>
                <span class="nx">saveCsv</span><span class="p">(</span><span class="nx">that</span><span class="p">,</span> <span class="nx">file</span><span class="p">,</span> <span class="nx">streamingWriteSync</span><span class="p">,</span> <span class="nx">cb</span><span class="p">,</span> <span class="nx">options</span><span class="p">,</span>
                    <span class="s1">&#39;saveSync&#39;</span>
                <span class="p">);</span>
            <span class="p">}</span>

        <span class="p">};</span></pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-8" id="section-8">&#182;</a>
</div>
<p>Set default format.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>        <span class="k">this</span><span class="p">.</span><span class="nx">setDefaultFormat</span><span class="p">(</span><span class="s1">&#39;json&#39;</span><span class="p">);</span>
    <span class="p">};</span></pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap" id="helper-methods">
  <h2>
    <a href="#helper-methods" class="pilcrow">&#182;</a>
    Helper Methods
  </h2>
</div>

        </td>
        <td class="code highlight"><div class="highlight"><pre></pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs"><div class="dox">
  <div class="summary">
<div class="pilwrap" id="loadcsv">
  <h3>
    <a href="#loadcsv" class="pilcrow">&#182;</a>
    loadCsv
  </h3>
</div>

  </div>
  <div class="body"><p>Reads csv file and inserts entries into db</p>

<p>Forwards reading to file to <code>readCb</code>.</p>
  </div>
  <div class="details">
    <div class="dox_tag_title">Params</div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name">that.</span>
      <span class="dox_type">NDDB</span>
      <span>An NDDB instance</span>
    </div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name">filename.</span>
      <span class="dox_type">string</span>
      <span>Name of the file in which to write</span>
    </div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name">readCb.</span>
      <span class="dox_type">function</span>
      <span>Callback with the same signature and effect as
  <code>streamingRead</code>.</span>
    </div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name">doneCb.</span>
      <span class="dox_type">function</span>
      <span>Callback to invoke upon completion</span>
    </div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name">options.</span>
      <span class="dox_type">object</span>
      <span>Options to be forwarded to
  <code>setDefaultCsvOptions</code> and <code>readCb</code></span>
    </div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name">method.</span>
      <span class="dox_type">string</span>
      <span>The name of the invoking method</span>
    </div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name">errorCb.</span>
      <span class="dox_type">function</span>
      <span>Callback to be passed an error.</span>
    </div>
    <div class="dox_tag_title">See</div>
    <div class="dox_tag_detail">
      <span class="dox_type">`setDefaultCsvOptions`</span>
    </div>
    <div class="dox_tag_title">See</div>
    <div class="dox_tag_detail">
      <span class="dox_type">`streamingWrite`
  </span>
    </div>
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre>    <span class="kd">function</span> <span class="nx">loadCsv</span><span class="p">(</span><span class="nx">that</span><span class="p">,</span> <span class="nx">filename</span><span class="p">,</span> <span class="nx">readCb</span><span class="p">,</span> <span class="nx">doneCb</span><span class="p">,</span> <span class="nx">options</span><span class="p">,</span> <span class="nx">method</span><span class="p">,</span>
        <span class="nx">errorCb</span><span class="p">)</span> <span class="p">{</span>

        <span class="kd">var</span> <span class="nx">headers</span><span class="p">,</span> <span class="nx">separator</span><span class="p">,</span> <span class="nx">quote</span><span class="p">,</span> <span class="nx">escapeCharacter</span><span class="p">;</span>
        <span class="kd">var</span> <span class="nx">obj</span><span class="p">,</span> <span class="nx">tokens</span><span class="p">,</span> <span class="nx">i</span><span class="p">,</span> <span class="nx">j</span><span class="p">,</span> <span class="nx">token</span><span class="p">,</span> <span class="nx">adapter</span><span class="p">;</span>
        <span class="kd">var</span> <span class="nx">processedTokens</span> <span class="o">=</span> <span class="p">[];</span>
        <span class="kd">var</span> <span class="nx">result</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">;</span></pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-11" id="section-11">&#182;</a>
</div>
<p>Options.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>        <span class="nx">setDefaultCsvOptions</span><span class="p">(</span><span class="nx">options</span><span class="p">,</span> <span class="nx">method</span><span class="p">);</span>
        <span class="nx">separator</span> <span class="o">=</span> <span class="nx">options</span><span class="p">.</span><span class="nx">separator</span><span class="p">;</span>
        <span class="nx">quote</span> <span class="o">=</span> <span class="nx">options</span><span class="p">.</span><span class="nx">quote</span><span class="p">;</span>
        <span class="nx">escapeCharacter</span> <span class="o">=</span> <span class="nx">options</span><span class="p">.</span><span class="nx">escapeCharacter</span><span class="p">;</span>
        <span class="nx">headers</span> <span class="o">=</span> <span class="nx">options</span><span class="p">.</span><span class="nx">headers</span><span class="p">;</span>
        <span class="nx">adapter</span> <span class="o">=</span> <span class="nx">options</span><span class="p">.</span><span class="nx">adapter</span> <span class="o">||</span> <span class="p">{};</span>

        <span class="nx">readCb</span><span class="p">(</span><span class="nx">filename</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">headers</span><span class="p">)</span> <span class="p">{</span></pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-12" id="section-12">&#182;</a>
</div>
<p>Self calling function for closure private variables.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>            <span class="kd">var</span> <span class="nx">firstCall</span><span class="p">;</span>
            <span class="nx">firstCall</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
            <span class="k">return</span> <span class="kd">function</span><span class="p">(</span><span class="nx">row</span><span class="p">)</span> <span class="p">{</span>
                <span class="kd">var</span> <span class="nx">str</span><span class="p">,</span> <span class="nx">headersFlag</span><span class="p">,</span> <span class="nx">insertTokens</span><span class="p">;</span>

                <span class="k">if</span> <span class="p">(</span><span class="nx">firstCall</span><span class="p">)</span> <span class="p">{</span>
                    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">headers</span><span class="p">)</span> <span class="p">{</span></pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-13" id="section-13">&#182;</a>
</div>
<p>Autogenerate all headers.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>                        <span class="nx">headers</span> <span class="o">=</span> <span class="p">[];</span>
                        <span class="nx">headersFlag</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
                    <span class="p">}</span>
                    <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">headers</span> <span class="o">===</span> <span class="kc">true</span><span class="p">)</span> <span class="p">{</span></pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-14" id="section-14">&#182;</a>
</div>
<p>Read first row as headers.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>                        <span class="nx">headers</span> <span class="o">=</span> <span class="p">[];</span>
                        <span class="nx">headersFlag</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
                    <span class="p">}</span>
                <span class="p">}</span>

                <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">row</span> <span class="o">||</span> <span class="o">!</span><span class="nx">row</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span>
                <span class="nx">result</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">;</span>
                <span class="nx">processedTokens</span> <span class="o">=</span> <span class="p">{};</span>
                <span class="nx">insertTokens</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
                <span class="nx">tokens</span> <span class="o">=</span> <span class="nx">row</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="nx">separator</span><span class="p">);</span></pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-15" id="section-15">&#182;</a>
</div>
<p>Processing tokens.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>                <span class="k">for</span> <span class="p">(</span><span class="nx">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">j</span> <span class="o">&lt;</span> <span class="nx">tokens</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="o">++</span><span class="nx">j</span><span class="p">)</span> <span class="p">{</span>
                    <span class="nx">token</span> <span class="o">=</span> <span class="nx">tokens</span><span class="p">[</span><span class="nx">j</span><span class="p">];</span>
                    <span class="k">if</span> <span class="p">(</span><span class="nx">token</span><span class="p">.</span><span class="nx">charAt</span><span class="p">(</span><span class="nx">token</span><span class="p">.</span><span class="nx">length</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">!==</span> <span class="nx">escapeCharacter</span><span class="p">)</span> <span class="p">{</span>
                        <span class="nx">result</span> <span class="o">+=</span> <span class="nx">token</span><span class="p">;</span>

                        <span class="nx">str</span> <span class="o">=</span> <span class="nx">parseCsvToken</span><span class="p">(</span>
                            <span class="nx">that</span><span class="p">,</span> <span class="nx">method</span><span class="p">,</span> <span class="nx">result</span><span class="p">,</span> <span class="nx">quote</span><span class="p">,</span> <span class="nx">escapeCharacter</span>
                        <span class="p">);</span>

                        <span class="k">if</span> <span class="p">(</span><span class="nx">firstCall</span><span class="p">)</span> <span class="p">{</span></pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-16" id="section-16">&#182;</a>
</div>
<p>Decide headersFlag for this entry.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>                            <span class="k">if</span> <span class="p">(</span><span class="nx">headersFlag</span> <span class="o">===</span> <span class="mi">0</span> <span class="o">||</span> <span class="nx">headersFlag</span> <span class="o">===</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span></pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-17" id="section-17">&#182;</a>
</div>
<p>Every entry treated the same way.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>                            <span class="p">}</span>
                            <span class="k">else</span> <span class="p">{</span>
                                <span class="k">if</span> <span class="p">(</span><span class="nx">headers</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">===</span> <span class="kc">true</span><span class="p">)</span> <span class="p">{</span></pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-18" id="section-18">&#182;</a>
</div>
<p>Select this entry to be read as header.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>                                    <span class="nx">headersFlag</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
                                <span class="p">}</span>
                                <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="nx">headers</span><span class="p">[</span><span class="nx">i</span><span class="p">])</span> <span class="p">{</span></pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-19" id="section-19">&#182;</a>
</div>
<p>This header is pre-defined.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>                                    <span class="nx">headersFlag</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
                                <span class="p">}</span>
                                <span class="k">else</span> <span class="p">{</span></pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-20" id="section-20">&#182;</a>
</div>
<p>This header should be autogenerated.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>                                    <span class="nx">headersFlag</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
                                <span class="p">}</span>
                            <span class="p">}</span></pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-21" id="section-21">&#182;</a>
</div>
<p>Act according to headersFlag.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>                            <span class="k">if</span> <span class="p">(</span><span class="nx">headersFlag</span> <span class="o">===</span> <span class="mi">0</span> <span class="o">||</span> <span class="nx">headersFlag</span> <span class="o">===</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span></pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-22" id="section-22">&#182;</a>
</div>
<p>Autogenerate header and insert token.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>                                <span class="nx">headers</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;X&#39;</span> <span class="o">+</span> <span class="p">(</span><span class="nx">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
                            <span class="p">}</span>

                            <span class="k">if</span> <span class="p">(</span><span class="nx">headersFlag</span> <span class="o">===</span> <span class="mi">1</span> <span class="o">||</span> <span class="nx">headersFlag</span> <span class="o">===</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span></pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-23" id="section-23">&#182;</a>
</div>
<p>Read token as header.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>                                <span class="nx">headers</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">=</span> <span class="nx">str</span><span class="p">;</span>
                                <span class="nx">insertTokens</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
                            <span class="p">}</span>
                        <span class="p">}</span>

                        <span class="k">if</span> <span class="p">(</span><span class="nx">insertTokens</span><span class="p">)</span> <span class="p">{</span>
                            <span class="nx">processedTokens</span><span class="p">[</span><span class="nx">headers</span><span class="p">[</span><span class="nx">i</span><span class="p">]]</span> <span class="o">=</span> <span class="nx">str</span><span class="p">;</span>
                        <span class="p">}</span>

                        <span class="nx">result</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">;</span>
                        <span class="nx">i</span><span class="o">++</span><span class="p">;</span>
                    <span class="p">}</span></pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-24" id="section-24">&#182;</a>
</div>
<p>Handle if token ends with escapeCharacter.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>                    <span class="k">else</span> <span class="p">{</span>
                        <span class="nx">result</span> <span class="o">+=</span> <span class="nx">token</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="nx">separator</span><span class="p">;</span>
                    <span class="p">}</span>
                <span class="p">}</span>

                <span class="k">if</span> <span class="p">(</span><span class="nx">insertTokens</span><span class="p">)</span> <span class="p">{</span>
                    <span class="nx">obj</span> <span class="o">=</span> <span class="p">{};</span>
                    <span class="nx">headers</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">h</span><span class="p">)</span> <span class="p">{</span>
                        <span class="k">if</span> <span class="p">(</span><span class="nx">adapter</span><span class="p">[</span><span class="nx">h</span><span class="p">])</span> <span class="p">{</span>
                            <span class="nx">obj</span><span class="p">[</span><span class="nx">h</span><span class="p">]</span> <span class="o">=</span> <span class="nx">adapter</span><span class="p">[</span><span class="nx">h</span><span class="p">](</span><span class="nx">processedTokens</span><span class="p">);</span>
                        <span class="p">}</span>
                        <span class="k">else</span> <span class="p">{</span>
                            <span class="nx">obj</span><span class="p">[</span><span class="nx">h</span><span class="p">]</span> <span class="o">=</span> <span class="nx">processedTokens</span><span class="p">[</span><span class="nx">h</span><span class="p">];</span>
                        <span class="p">}</span>
                    <span class="p">});</span>
                    <span class="nx">that</span><span class="p">.</span><span class="nx">insert</span><span class="p">(</span><span class="nx">obj</span><span class="p">);</span>
                <span class="p">}</span>

                <span class="nx">firstCall</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
            <span class="p">};</span>
        <span class="p">}(</span><span class="nx">headers</span><span class="p">),</span> <span class="nx">doneCb</span><span class="p">,</span> <span class="nx">options</span><span class="p">,</span> <span class="nx">errorCb</span><span class="p">);</span>
    <span class="p">}</span></pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs"><div class="dox">
  <div class="summary">
<div class="pilwrap" id="savecsv">
  <h3>
    <a href="#savecsv" class="pilcrow">&#182;</a>
    saveCsv
  </h3>
</div>

  </div>
  <div class="body"><p>Fetches data from db and writes it to csv file</p>

<p>Forwards writing to file to <code>writeCb</code>.</p>
  </div>
  <div class="details">
    <div class="dox_tag_title">Params</div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name">that.</span>
      <span class="dox_type">NDDB</span>
      <span>An NDDB instance</span>
    </div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name">filename.</span>
      <span class="dox_type">string</span>
      <span>Name of the file in which to write</span>
    </div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name">writeCb.</span>
      <span class="dox_type">function</span>
      <span>Callback with the same signature and effect as
  <code>streamingWrite</code>.</span>
    </div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name">doneCb.</span>
      <span class="dox_type">function</span>
      <span>Callback to invoke upon completion of save</span>
    </div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name">options.</span>
      <span class="dox_type">object</span>
      <span>Options to be forwarded to
  <code>setDefaultCsvOptions</code> and <code>writeCb</code></span>
    </div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name">method.</span>
      <span class="dox_type">string</span>
      <span>The name of the invoking method</span>
    </div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name">errorCb.</span>
      <span class="dox_type">function</span>
      <span>Callback to be passed an error.</span>
    </div>
    <div class="dox_tag_title">See</div>
    <div class="dox_tag_detail">
      <span class="dox_type">`setDefaultCsvOptions`</span>
    </div>
    <div class="dox_tag_title">See</div>
    <div class="dox_tag_detail">
      <span class="dox_type">`streamingWrite`
  </span>
    </div>
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre>    <span class="kd">function</span> <span class="nx">saveCsv</span><span class="p">(</span><span class="nx">that</span><span class="p">,</span> <span class="nx">filename</span><span class="p">,</span> <span class="nx">writeCb</span><span class="p">,</span> <span class="nx">doneCb</span><span class="p">,</span> <span class="nx">options</span><span class="p">,</span>
        <span class="nx">method</span><span class="p">,</span> <span class="nx">errorCb</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">headers</span><span class="p">,</span> <span class="nx">adapter</span><span class="p">;</span>
        <span class="kd">var</span> <span class="nx">separator</span><span class="p">,</span> <span class="nx">quote</span><span class="p">,</span> <span class="nx">escapeCharacter</span><span class="p">,</span> <span class="nx">na</span><span class="p">;</span>
        <span class="kd">var</span> <span class="nx">data</span><span class="p">;</span>
        <span class="kd">var</span> <span class="nx">i</span><span class="p">,</span> <span class="nx">len</span><span class="p">;</span></pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-26" id="section-26">&#182;</a>
</div>
<p>Options.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>        <span class="nx">setDefaultCsvOptions</span><span class="p">(</span><span class="nx">options</span><span class="p">,</span> <span class="nx">method</span><span class="p">);</span>
        <span class="nx">na</span> <span class="o">=</span> <span class="nx">options</span><span class="p">.</span><span class="nx">na</span><span class="p">;</span>
        <span class="nx">separator</span> <span class="o">=</span> <span class="nx">options</span><span class="p">.</span><span class="nx">separator</span><span class="p">;</span>
        <span class="nx">quote</span> <span class="o">=</span> <span class="nx">options</span><span class="p">.</span><span class="nx">quote</span><span class="p">;</span>
        <span class="nx">escapeCharacter</span> <span class="o">=</span> <span class="nx">options</span><span class="p">.</span><span class="nx">escapeCharacter</span><span class="p">;</span>

        <span class="nx">data</span> <span class="o">=</span> <span class="nx">that</span><span class="p">.</span><span class="nx">fetch</span><span class="p">();</span>
        <span class="nx">headers</span> <span class="o">=</span> <span class="nx">getCsvHeaders</span><span class="p">(</span><span class="nx">options</span><span class="p">.</span><span class="nx">headers</span><span class="p">,</span> <span class="nx">data</span><span class="p">);</span>
        <span class="nx">adapter</span> <span class="o">=</span> <span class="nx">options</span><span class="p">.</span><span class="nx">adapter</span> <span class="o">||</span> <span class="p">{};</span>

        <span class="nx">writeCb</span><span class="p">(</span><span class="nx">filename</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span></pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-27" id="section-27">&#182;</a>
</div>
<p>Self calling function for closure private variables.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>            <span class="kd">var</span> <span class="nx">firstCall</span><span class="p">,</span> <span class="nx">currentItem</span><span class="p">;</span>
            <span class="nx">firstCall</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
            <span class="nx">currentItem</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
            <span class="k">return</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
                <span class="kd">var</span> <span class="nx">line</span><span class="p">;</span>
                <span class="nx">line</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">;</span>
                <span class="k">if</span> <span class="p">(</span><span class="nx">firstCall</span> <span class="o">&amp;&amp;</span> <span class="nx">headers</span><span class="p">)</span> <span class="p">{</span>
                    <span class="nx">len</span> <span class="o">=</span> <span class="nx">headers</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span>
                    <span class="k">for</span> <span class="p">(</span><span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span> <span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">len</span> <span class="p">;</span> <span class="o">++</span><span class="nx">i</span><span class="p">)</span> <span class="p">{</span>
                        <span class="nx">line</span> <span class="o">+=</span> <span class="nx">createCsvToken</span><span class="p">(</span><span class="nx">headers</span><span class="p">[</span><span class="nx">i</span><span class="p">],</span> <span class="nx">separator</span><span class="p">,</span> <span class="nx">quote</span><span class="p">,</span>
                                              <span class="nx">escapeCharacter</span><span class="p">);</span>

                        <span class="k">if</span> <span class="p">(</span><span class="nx">i</span> <span class="o">!==</span> <span class="p">(</span><span class="nx">len</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span> <span class="nx">line</span> <span class="o">+=</span> <span class="nx">separator</span><span class="p">;</span>
                    <span class="p">}</span>
                    <span class="nx">firstCall</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
                    <span class="k">return</span> <span class="nx">line</span><span class="p">;</span>
                <span class="p">}</span>
                <span class="k">if</span> <span class="p">(</span><span class="nx">currentItem</span> <span class="o">&lt;</span> <span class="nx">data</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span> <span class="p">{</span>
                    <span class="k">return</span> <span class="nx">getCsvRow</span><span class="p">(</span><span class="nx">that</span><span class="p">,</span> <span class="nx">method</span><span class="p">,</span> <span class="nx">data</span><span class="p">[</span><span class="nx">currentItem</span><span class="o">++</span><span class="p">],</span> <span class="nx">headers</span><span class="p">,</span>
                        <span class="nx">adapter</span><span class="p">,</span> <span class="nx">separator</span><span class="p">,</span> <span class="nx">quote</span><span class="p">,</span> <span class="nx">escapeCharacter</span><span class="p">,</span> <span class="nx">na</span><span class="p">);</span>
                <span class="p">}</span>
                <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
            <span class="p">};</span>
        <span class="p">}(),</span> <span class="nx">doneCb</span><span class="p">,</span> <span class="nx">options</span><span class="p">,</span> <span class="nx">errorCb</span><span class="p">);</span>
    <span class="p">}</span></pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs"><div class="dox">
  <div class="summary">
<div class="pilwrap" id="setdefaultcsvoptions">
  <h3>
    <a href="#setdefaultcsvoptions" class="pilcrow">&#182;</a>
    setDefaultCsvOptions
  </h3>
</div>

  </div>
  <div class="body"><p>Set default options depending on the CSV method</p>

<p>Available options and defaults:</p>

<div class='highlight'><pre><code language=''>{

  headers: true,                     // if options.headers === true: use
                                     //   first line of file as headers;
                                     // if !options.headers: use
                                     //   ['X1'...'XN'] as headers;
                                     // if options.headers is an array of
                                     //   strings use it as headers;
                                     // if options.headers is an array
                                     //   containing true/false use entry
                                     //   from file/'Xi' respectively;


  adapter: { A: function(row) {      // An obj containing callbacks for
                 return row['A'];    // each header. The callbacks take
                }                    // an object of strings and
           },                        // return a string. Each entry in
                                     // the file is the result of
                                     // applying the callback of its
                                     // column to its row.


  separator: ',',                    // The character used as separator
                                     // between values. Default ','.

  quote: '"',                        // The character used as quote.
                                     // Default: '"'.

  escapeCharacter: '\',              // The char that should be skipped.
                                     // Default: '\'.

  commentchar: '',                   // The character used for comments.
                                     // Default: ''.

  nestedQuotes: false,               // TRUE, if nested quotes allowed.
                                     // Default FALSE.

  flags: 'w',                        // The Node.js flag to write to fs.
                                     // Default: 'a' (append).

  encoding: 'utf-8',                 // The encoding of the file.

  mode: 0777,                        // The permission given to the file.
                                     // Default: 0666

}
</code></pre></div>
  </div>
  <div class="details">
    <div class="dox_tag_title">Params</div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name">options</span>
      <span class="dox_type">object</span>
      <span>Initial options (will be modified)</span>
    </div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name">method</span>
      <span class="dox_type">string</span>
      <span>The name of the invoking method</span>
    </div>
    <div class="dox_tag_title">See</div>
    <div class="dox_tag_detail">
      <a href=" ">http://nodejs.org/api/fs.html#fs_fs_createwritestream_path_options
</a>
    </div>
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre>    <span class="kd">function</span> <span class="nx">setDefaultCsvOptions</span><span class="p">(</span><span class="nx">options</span><span class="p">,</span> <span class="nx">method</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">options</span><span class="p">.</span><span class="nx">columnNames</span><span class="p">)</span> <span class="nx">options</span><span class="p">.</span><span class="nx">columnNames</span> <span class="o">=</span> <span class="kc">undefined</span><span class="p">;</span>

        <span class="k">if</span> <span class="p">(</span><span class="nx">method</span> <span class="o">===</span> <span class="s1">&#39;load&#39;</span> <span class="o">||</span> <span class="nx">method</span> <span class="o">===</span> <span class="s1">&#39;loadSync&#39;</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">options</span><span class="p">.</span><span class="nx">headers</span> <span class="o">&amp;&amp;</span>
                <span class="s1">&#39;undefined&#39;</span> <span class="o">===</span> <span class="k">typeof</span> <span class="nx">options</span><span class="p">.</span><span class="nx">columnsFromHeader</span><span class="p">)</span> <span class="p">{</span>

                <span class="nx">options</span><span class="p">.</span><span class="nx">columnsFromHeader</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
            <span class="p">}</span>
        <span class="p">}</span>
        <span class="k">else</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="nx">options</span><span class="p">.</span><span class="nx">columnsFromHeader</span><span class="p">)</span> <span class="p">{</span>
                <span class="nx">options</span><span class="p">.</span><span class="nx">columnsFromHeader</span> <span class="o">=</span> <span class="kc">undefined</span><span class="p">;</span>
            <span class="p">}</span>
            <span class="nx">options</span><span class="p">.</span><span class="nx">flags</span> <span class="o">=</span> <span class="nx">options</span><span class="p">.</span><span class="nx">flags</span> <span class="o">||</span> <span class="s1">&#39;a&#39;</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="k">if</span> <span class="p">(</span><span class="s2">&quot;undefined&quot;</span> <span class="o">===</span> <span class="k">typeof</span> <span class="nx">options</span><span class="p">.</span><span class="nx">headers</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">options</span><span class="p">.</span><span class="nx">headers</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="nx">options</span><span class="p">.</span><span class="nx">na</span> <span class="o">=</span> <span class="nx">options</span><span class="p">.</span><span class="nx">na</span> <span class="o">||</span> <span class="s1">&#39;NA&#39;</span><span class="p">;</span>
        <span class="nx">options</span><span class="p">.</span><span class="nx">separator</span> <span class="o">=</span> <span class="nx">options</span><span class="p">.</span><span class="nx">separator</span> <span class="o">||</span> <span class="s1">&#39;,&#39;</span><span class="p">;</span>
        <span class="nx">options</span><span class="p">.</span><span class="nx">quote</span> <span class="o">=</span> <span class="nx">options</span><span class="p">.</span><span class="nx">quote</span> <span class="o">||</span> <span class="s1">&#39;&quot;&#39;</span><span class="p">;</span>
        <span class="nx">options</span><span class="p">.</span><span class="nx">escapeCharacter</span> <span class="o">=</span> <span class="nx">options</span><span class="p">.</span><span class="nx">escapeCharacter</span> <span class="o">||</span> <span class="s1">&#39;\\&#39;</span><span class="p">;</span></pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-29" id="section-29">&#182;</a>
</div>
<p>options.escapeCharacter = options.escapeCharacter  || options.quote;</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>    <span class="p">}</span></pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs"><div class="dox">
  <div class="summary">
<div class="pilwrap" id="getcsvheaders">
  <h3>
    <a href="#getcsvheaders" class="pilcrow">&#182;</a>
    getCsvHeaders
  </h3>
</div>

  </div>
  <div class="body"><p>Returns the CSV headers from data or headers</p>
  </div>
  <div class="details">
    <div class="dox_tag_title">Params</div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name">headers</span>
      <span class="dox_type">array</span>
      <span>Optional. An array of headers returned as it is</span>
    </div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name">data</span>
      <span class="dox_type">array</span>
      <span>Optional. Array containing the items to save</span>
    </div>
    <div class="dox_tag_title">Returns</div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name"></span>
      <span class="dox_type">array</span>
      <span class="dox_type">null</span>
      <span>h The headers, or NULL if not found</span>
    </div>
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre>    <span class="kd">function</span> <span class="nx">getCsvHeaders</span><span class="p">(</span><span class="nx">headers</span><span class="p">,</span> <span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">h</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">headers</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">J</span><span class="p">.</span><span class="nx">isArray</span><span class="p">(</span><span class="nx">headers</span><span class="p">))</span> <span class="k">return</span> <span class="nx">headers</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">data</span> <span class="o">&amp;&amp;</span> <span class="nx">J</span><span class="p">.</span><span class="nx">isArray</span><span class="p">(</span><span class="nx">data</span><span class="p">))</span> <span class="p">{</span>
            <span class="nx">h</span> <span class="o">=</span> <span class="nx">J</span><span class="p">.</span><span class="nx">keys</span><span class="p">(</span><span class="nx">data</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">1</span><span class="p">);</span>
            <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">h</span> <span class="o">||</span> <span class="o">!</span><span class="nx">h</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span> <span class="nx">h</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
            <span class="k">return</span> <span class="nx">h</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span></pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs"><div class="dox">
  <div class="summary">
<div class="pilwrap" id="getcsvrow">
  <h3>
    <a href="#getcsvrow" class="pilcrow">&#182;</a>
    getCsvRow
  </h3>
</div>

  </div>
  <div class="body"><p>Evaluates an item and returns a csv string with only the required values</p>
  </div>
  <div class="details">
    <div class="dox_tag_title">Params</div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name">item</span>
      <span class="dox_type">object</span>
      <span>An item from database</span>
    </div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name">headers</span>
      <span class="dox_type">array</span>
      <span>Optional. An array of fields to take from the item</span>
    </div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name">adapter</span>
      <span class="dox_type">object</span>
      <span>Optional. An object containing callbacks to
  be used to pre-process the values of the corresponding key before
  returning it</span>
    </div>
    <div class="dox_tag_title">Returns</div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name"></span>
      <span class="dox_type">string</span>
      <span>A Csv row of values ready to be written to file</span>
    </div>
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre>    <span class="kd">function</span> <span class="nx">getCsvRow</span><span class="p">(</span><span class="nx">that</span><span class="p">,</span> <span class="nx">method</span><span class="p">,</span> <span class="nx">item</span><span class="p">,</span> <span class="nx">headers</span><span class="p">,</span> <span class="nx">adapter</span><span class="p">,</span> <span class="nx">separator</span><span class="p">,</span>
                       <span class="nx">quote</span><span class="p">,</span> <span class="nx">escapeCharacter</span><span class="p">,</span> <span class="nx">na</span><span class="p">)</span> <span class="p">{</span>

        <span class="kd">var</span> <span class="nx">out</span><span class="p">,</span> <span class="nx">key</span><span class="p">;</span>
        <span class="nx">out</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">headers</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">for</span> <span class="p">(</span><span class="nx">key</span> <span class="k">in</span> <span class="nx">item</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">if</span> <span class="p">(</span><span class="nx">item</span><span class="p">.</span><span class="nx">hasOwnProperty</span><span class="p">(</span><span class="nx">key</span><span class="p">))</span> <span class="p">{</span>
                    <span class="nx">out</span> <span class="o">+=</span> <span class="nx">createCsvToken</span><span class="p">(</span><span class="nx">item</span><span class="p">[</span><span class="nx">key</span><span class="p">],</span> <span class="nx">separator</span><span class="p">,</span> <span class="nx">quote</span><span class="p">,</span>
                                        <span class="nx">escapeCharacter</span><span class="p">,</span> <span class="nx">na</span><span class="p">)</span> <span class="o">+</span> <span class="nx">separator</span><span class="p">;</span>
                <span class="p">}</span>
            <span class="p">}</span>
        <span class="p">}</span>
        <span class="k">else</span> <span class="p">{</span>
            <span class="nx">headers</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">h</span><span class="p">)</span> <span class="p">{</span>
                <span class="kd">var</span> <span class="nx">str</span><span class="p">;</span>
                <span class="k">if</span> <span class="p">(</span><span class="nx">adapter</span><span class="p">[</span><span class="nx">h</span><span class="p">])</span> <span class="nx">str</span> <span class="o">=</span> <span class="nx">adapter</span><span class="p">[</span><span class="nx">h</span><span class="p">](</span><span class="nx">item</span><span class="p">);</span>
                <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">item</span><span class="p">.</span><span class="nx">hasOwnProperty</span><span class="p">(</span><span class="nx">h</span><span class="p">))</span> <span class="nx">str</span> <span class="o">=</span> <span class="nx">item</span><span class="p">[</span><span class="nx">h</span><span class="p">];</span>
                <span class="k">else</span> <span class="nx">str</span> <span class="o">=</span> <span class="nx">na</span><span class="p">;</span>
                <span class="nx">out</span> <span class="o">+=</span> <span class="nx">createCsvToken</span><span class="p">(</span><span class="nx">str</span><span class="p">,</span> <span class="nx">separator</span><span class="p">,</span> <span class="nx">quote</span><span class="p">,</span> <span class="nx">escapeCharacter</span><span class="p">,</span>
                    <span class="nx">na</span><span class="p">)</span> <span class="o">+</span> <span class="nx">separator</span><span class="p">;</span>
            <span class="p">});</span>
        <span class="p">}</span></pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-32" id="section-32">&#182;</a>
</div>
<p>Remove last comma.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>        <span class="k">return</span> <span class="nx">out</span><span class="p">.</span><span class="nx">substring</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nx">out</span><span class="p">.</span><span class="nx">length</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>
    <span class="p">}</span></pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs"><div class="dox">
  <div class="summary">
<div class="pilwrap" id="parsecsvtoken">
  <h3>
    <a href="#parsecsvtoken" class="pilcrow">&#182;</a>
    parseCsvToken
  </h3>
</div>

  </div>
  <div class="body"><p>Parses a string representing an entry from a CSV row</p>
  </div>
  <div class="details">
    <div class="dox_tag_title">Params</div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name">that</span>
      <span class="dox_type">NDDB</span>
      <span>An NDDB instance</span>
    </div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name">method</span>
      <span class="dox_type">string</span>
      <span>The name of the invoking metho</span>
    </div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name">token</span>
      <span class="dox_type">object</span>
      <span>The string to parse</span>
    </div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name">quote</span>
      <span class="dox_type">string</span>
      <span>Optional. A character to escape</span>
    </div>
    <div class="dox_tag_title">Returns</div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name"></span>
      <span class="dox_type">string</span>
      <span>The parsed token</span>
    </div>
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre>    <span class="kd">function</span> <span class="nx">parseCsvToken</span><span class="p">(</span><span class="nx">that</span><span class="p">,</span> <span class="nx">method</span><span class="p">,</span> <span class="nx">token</span><span class="p">,</span> <span class="nx">quote</span><span class="p">,</span> <span class="nx">escapeCharacter</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">quote</span> <span class="o">&amp;&amp;</span> <span class="nx">token</span><span class="p">.</span><span class="nx">charAt</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">===</span> <span class="nx">quote</span><span class="p">)</span> <span class="p">{</span>

            <span class="k">if</span> <span class="p">(</span><span class="nx">token</span><span class="p">.</span><span class="nx">charAt</span><span class="p">(</span><span class="nx">token</span><span class="p">.</span><span class="nx">length</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">!==</span> <span class="nx">quote</span><span class="p">)</span> <span class="p">{</span>
                <span class="nx">that</span><span class="p">.</span><span class="nx">throwErr</span><span class="p">(</span><span class="s1">&#39;Error&#39;</span><span class="p">,</span> <span class="nx">method</span><span class="p">,</span> <span class="s1">&#39;missing closing quote char: &#39;</span> <span class="o">+</span>
                              <span class="nx">token</span><span class="p">);</span>
            <span class="p">}</span>
            <span class="nx">token</span> <span class="o">=</span> <span class="nx">token</span><span class="p">.</span><span class="nx">substring</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nx">token</span><span class="p">.</span><span class="nx">length</span> <span class="o">-</span><span class="mi">1</span><span class="p">);</span>
        <span class="p">}</span></pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-34" id="section-34">&#182;</a>
</div>
<p>Unescape quote, ecapeCharacter, linebreak and tab.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>        <span class="k">return</span> <span class="nx">token</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="nx">escapeCharacter</span> <span class="o">+</span> <span class="nx">quote</span><span class="p">).</span><span class="nx">join</span><span class="p">(</span><span class="nx">quote</span><span class="p">)</span>
                    <span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="nx">escapeCharacter</span> <span class="o">+</span> <span class="nx">escapeCharacter</span><span class="p">)</span>
                    <span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="nx">escapeCharacter</span><span class="p">)</span>
                    <span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="nx">escapeCharacter</span> <span class="o">+</span> <span class="s1">&#39;\t&#39;</span><span class="p">).</span><span class="nx">join</span><span class="p">(</span><span class="s1">&#39;\t&#39;</span><span class="p">)</span>
                    <span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="nx">escapeCharacter</span> <span class="o">+</span> <span class="s1">&#39;\n&#39;</span><span class="p">).</span><span class="nx">join</span><span class="p">(</span><span class="s1">&#39;\n&#39;</span><span class="p">);</span>

    <span class="p">}</span></pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs"><div class="dox">
  <div class="summary">
<div class="pilwrap" id="createcsvtoken">
  <h3>
    <a href="#createcsvtoken" class="pilcrow">&#182;</a>
    createCsvToken
  </h3>
</div>

  </div>
  <div class="body"><p>Converts and escapes a token into the value of a csv field</p>
  </div>
  <div class="details">
    <div class="dox_tag_title">Params</div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name">token</span>
      <span class="dox_type">mixed</span>
      <span>The string to parse. Other types will be converted,
  undefined and null are transformed into NA.</span>
    </div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name">quote</span>
      <span class="dox_type">string</span>
      <span>Optional. A character to surround the value</span>
    </div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name">quote</span>
      <span class="dox_type">string</span>
      <span>Optional. A character to escape</span>
    </div>
    <div class="dox_tag_title">Returns</div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name"></span>
      <span class="dox_type">string</span>
      <span>The parsed token</span>
    </div>
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre>    <span class="kd">function</span> <span class="nx">createCsvToken</span><span class="p">(</span><span class="nx">token</span><span class="p">,</span> <span class="nx">separator</span><span class="p">,</span> <span class="nx">quote</span><span class="p">,</span> <span class="nx">escapeCharacter</span><span class="p">,</span> <span class="nx">na</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">i</span><span class="p">,</span> <span class="nx">len</span><span class="p">,</span> <span class="nx">out</span><span class="p">,</span> <span class="nx">c</span><span class="p">;</span></pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-36" id="section-36">&#182;</a>
</div>
<p>We are not interested in outputting "null" or "undefined"</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>        <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;undefined&#39;</span> <span class="o">===</span> <span class="k">typeof</span> <span class="nx">token</span> <span class="o">||</span> <span class="nx">token</span> <span class="o">===</span> <span class="kc">null</span><span class="p">)</span> <span class="nx">token</span> <span class="o">=</span> <span class="nx">na</span><span class="p">;</span>
        <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;string&#39;</span> <span class="o">!==</span> <span class="k">typeof</span> <span class="nx">token</span><span class="p">)</span> <span class="nx">token</span> <span class="o">=</span> <span class="nb">String</span><span class="p">(</span><span class="nx">token</span><span class="p">);</span></pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-37" id="section-37">&#182;</a>
</div>
<p>Escape quote, separator, escapeCharacter, linebreak and tab.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>        <span class="k">if</span> <span class="p">(</span><span class="nx">quote</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">out</span> <span class="o">=</span> <span class="nx">quote</span><span class="p">;</span>
            <span class="k">if</span> <span class="p">(</span><span class="nx">escapeCharacter</span><span class="p">)</span> <span class="p">{</span>
                <span class="nx">len</span> <span class="o">=</span> <span class="nx">token</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span>
                <span class="k">for</span> <span class="p">(</span><span class="nx">i</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span> <span class="p">;</span> <span class="o">++</span><span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">len</span> <span class="p">;</span> <span class="p">)</span> <span class="p">{</span>
                    <span class="nx">c</span> <span class="o">=</span> <span class="nx">token</span><span class="p">.</span><span class="nx">charAt</span><span class="p">(</span><span class="nx">i</span><span class="p">);</span>
                    <span class="k">if</span> <span class="p">(</span><span class="nx">c</span> <span class="o">===</span> <span class="nx">quote</span> <span class="o">||</span> <span class="nx">c</span> <span class="o">===</span> <span class="nx">escapeCharacter</span> <span class="o">||</span>
                        <span class="nx">c</span> <span class="o">===</span> <span class="nx">separator</span> <span class="o">||</span> <span class="nx">c</span> <span class="o">===</span> <span class="s1">&#39;\n&#39;</span> <span class="o">||</span> <span class="nx">c</span> <span class="o">===</span> <span class="s1">&#39;\t&#39;</span><span class="p">)</span> <span class="p">{</span>
                        <span class="nx">out</span> <span class="o">+=</span> <span class="nx">escapeCharacter</span><span class="p">;</span>
                    <span class="p">}</span>
                    <span class="nx">out</span> <span class="o">+=</span> <span class="nx">c</span><span class="p">;</span>
                <span class="p">}</span>
            <span class="p">}</span>
            <span class="k">else</span> <span class="p">{</span>
                <span class="nx">out</span> <span class="o">+=</span> <span class="nx">token</span><span class="p">;</span>
            <span class="p">}</span>
            <span class="nx">out</span> <span class="o">+=</span> <span class="nx">quote</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="nx">out</span><span class="p">;</span>
    <span class="p">}</span></pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs"><div class="dox">
  <div class="summary">
<div class="pilwrap" id="loadcb">
  <h3>
    <a href="#loadcb" class="pilcrow">&#182;</a>
    loadCb
  </h3>
</div>

  </div>
  <div class="body"><p>Retrocycles a string into an array of objects and imports it into a db</p>
  </div>
  <div class="details">
    <div class="dox_tag_title">Params</div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name">nddb.</span>
      <span class="dox_type">NDDB</span>
      <span>An NDDB instance</span>
    </div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name">s.</span>
      <span class="dox_type">string</span>
      <span>The string to retrocycle and import</span>
    </div>
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre>    <span class="kd">function</span> <span class="nx">loadCb</span><span class="p">(</span><span class="nx">nddb</span><span class="p">,</span> <span class="nx">s</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">items</span><span class="p">,</span> <span class="nx">i</span><span class="p">;</span>
        <span class="nx">items</span> <span class="o">=</span> <span class="nx">J</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="nx">s</span><span class="p">);</span></pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-39" id="section-39">&#182;</a>
</div>
<p>TODO: copy settings, disable updates,
insert one by one, update indexes.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>        <span class="k">for</span> <span class="p">(</span><span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">items</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span></pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-40" id="section-40">&#182;</a>
</div>
<p>Retrocycle if possible.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>            <span class="nx">items</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">=</span> <span class="nx">NDDB</span><span class="p">.</span><span class="nx">retrocycle</span><span class="p">(</span><span class="nx">items</span><span class="p">[</span><span class="nx">i</span><span class="p">]);</span>
        <span class="p">}</span>
        <span class="nx">nddb</span><span class="p">.</span><span class="nx">importDB</span><span class="p">(</span><span class="nx">items</span><span class="p">);</span>
    <span class="p">}</span></pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs"><div class="dox">
  <div class="summary">
<div class="pilwrap" id="streamingread">
  <h3>
    <a href="#streamingread" class="pilcrow">&#182;</a>
    streamingRead
  </h3>
</div>

  </div>
  <div class="body"><p>Streams file in and applies callback to each line asynchronousely</p>
  </div>
  <div class="details">
    <div class="dox_tag_title">Params</div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name">filename.</span>
      <span class="dox_type">string</span>
      <span>Name of file to load into database</span>
    </div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name">lineProcessorCb.</span>
      <span class="dox_type">function</span>
      <span>Callback to forward to
  <code>processFileStreamInSync</code></span>
    </div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name">options.</span>
      <span class="dox_type">object</span>
      <span>May contain property <code>flag</code> forwarded to
  <code>fs.open</code> (default: 'r'). All options are forwarded to
  <code>processFileStreamOutSync</code>.</span>
    </div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name">errorCb.</span>
      <span class="dox_type">function</span>
      <span>Callback to be passed an error.</span>
    </div>
    <div class="dox_tag_title">See</div>
    <div class="dox_tag_detail">
      <span class="dox_type">`fs.open`</span>
    </div>
    <div class="dox_tag_title">See</div>
    <div class="dox_tag_detail">
      <span class="dox_type">`processFileStreamInSync`
  </span>
    </div>
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre>    <span class="kd">function</span> <span class="nx">streamingRead</span><span class="p">(</span><span class="nx">filename</span><span class="p">,</span> <span class="nx">lineProcessorCb</span><span class="p">,</span> <span class="nx">doneCb</span><span class="p">,</span> <span class="nx">options</span><span class="p">,</span>
        <span class="nx">errorCb</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">flag</span><span class="p">;</span></pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-42" id="section-42">&#182;</a>
</div>
<p>Open file.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>        <span class="nx">flag</span> <span class="o">=</span> <span class="nx">options</span><span class="p">.</span><span class="nx">flag</span> <span class="o">||</span> <span class="s1">&#39;r&#39;</span><span class="p">;</span>
        <span class="nx">fs</span><span class="p">.</span><span class="nx">open</span><span class="p">(</span><span class="nx">filename</span><span class="p">,</span> <span class="nx">flag</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">fd</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
                <span class="nx">errorCb</span><span class="p">(</span><span class="nx">err</span><span class="p">);</span>
            <span class="p">}</span>
            <span class="k">else</span> <span class="p">{</span>
                <span class="k">try</span> <span class="p">{</span>
                    <span class="nx">processFileStreamInSync</span><span class="p">(</span><span class="nx">fd</span><span class="p">,</span> <span class="nx">lineProcessorCb</span><span class="p">,</span>  <span class="nx">options</span><span class="p">);</span>
                    <span class="k">if</span> <span class="p">(</span><span class="nx">doneCb</span><span class="p">)</span> <span class="nx">doneCb</span><span class="p">();</span>
                <span class="p">}</span>
                <span class="k">catch</span> <span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
                    <span class="nx">errorCb</span><span class="p">(</span><span class="nx">e</span><span class="p">);</span>
                <span class="p">}</span>
            <span class="p">}</span>
        <span class="p">});</span>
    <span class="p">}</span></pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs"><div class="dox">
  <div class="summary">
<div class="pilwrap" id="streamingreadsync">
  <h3>
    <a href="#streamingreadsync" class="pilcrow">&#182;</a>
    streamingReadSync
  </h3>
</div>

  </div>
  <div class="body"><p>Streams file in and applies callback to each line</p>
  </div>
  <div class="details">
    <div class="dox_tag_title">Params</div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name">filename.</span>
      <span class="dox_type">string</span>
      <span>Name of file to load into database</span>
    </div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name">lineProcessorCb.</span>
      <span class="dox_type">function</span>
      <span>Callback to forward to
  <code>processFileStreamInSync</code></span>
    </div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name">options.</span>
      <span class="dox_type">object</span>
      <span>May contain property <code>flag</code> forwarded to
  <code>fs.open</code> (default: 'r'). All options are forwarded to
  <code>processFileStreamOutSync</code>.</span>
    </div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name">errorCb.</span>
      <span class="dox_type">function</span>
      <span>Callback to be passed an error.</span>
    </div>
    <div class="dox_tag_title">See</div>
    <div class="dox_tag_detail">
      <span class="dox_type">`fs.open`</span>
    </div>
    <div class="dox_tag_title">See</div>
    <div class="dox_tag_detail">
      <span class="dox_type">`processFileStreamInSync`
  </span>
    </div>
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre>    <span class="kd">function</span> <span class="nx">streamingReadSync</span><span class="p">(</span><span class="nx">filename</span><span class="p">,</span> <span class="nx">lineProcessorCb</span><span class="p">,</span> <span class="nx">doneCb</span><span class="p">,</span> <span class="nx">options</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">fd</span><span class="p">,</span> <span class="nx">flag</span><span class="p">;</span></pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-44" id="section-44">&#182;</a>
</div>
<p>Open file.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>        <span class="nx">flag</span> <span class="o">=</span> <span class="nx">options</span><span class="p">.</span><span class="nx">flag</span> <span class="o">||</span> <span class="s1">&#39;r&#39;</span><span class="p">;</span>
        <span class="nx">fd</span> <span class="o">=</span> <span class="nx">fs</span><span class="p">.</span><span class="nx">openSync</span><span class="p">(</span><span class="nx">filename</span><span class="p">,</span> <span class="nx">flag</span><span class="p">);</span>
        <span class="nx">processFileStreamInSync</span><span class="p">(</span><span class="nx">fd</span><span class="p">,</span> <span class="nx">lineProcessorCb</span><span class="p">,</span> <span class="nx">options</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">doneCb</span><span class="p">)</span> <span class="nx">doneCb</span><span class="p">();</span>
    <span class="p">}</span></pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs"><div class="dox">
  <div class="summary">
<div class="pilwrap" id="streamingwrite">
  <h3>
    <a href="#streamingwrite" class="pilcrow">&#182;</a>
    streamingWrite
  </h3>
</div>

  </div>
  <div class="body"><p>Gets lines from callback and streams them to file asynchronously</p>
  </div>
  <div class="details">
    <div class="dox_tag_title">Params</div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name">filename.</span>
      <span class="dox_type">string</span>
      <span>Name of the file to which to write</span>
    </div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name">lineCreatorCb.</span>
      <span class="dox_type">function</span>
      <span>Callback to forward to
  <code>processFileStreamOutSync</code></span>
    </div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name">doneCb.</span>
      <span class="dox_type">function</span>
      <span>Callback to be executed upon completion</span>
    </div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name">options.</span>
      <span class="dox_type">object</span>
      <span>May contain property <code>flag</code> forwarded to
  <code>fs.open</code> (default: 'w'). All options are forwarded to
  <code>processFileStreamOutSync</code>.</span>
    </div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name">errorCb.</span>
      <span class="dox_type">function</span>
      <span>Callback to be passed an error.</span>
    </div>
    <div class="dox_tag_title">See</div>
    <div class="dox_tag_detail">
      <span class="dox_type">`fs.open`</span>
    </div>
    <div class="dox_tag_title">See</div>
    <div class="dox_tag_detail">
      <span class="dox_type">`processFileStreamOutSync`
  </span>
    </div>
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre>    <span class="kd">function</span> <span class="nx">streamingWrite</span><span class="p">(</span><span class="nx">filename</span><span class="p">,</span> <span class="nx">lineCreatorCb</span><span class="p">,</span> <span class="nx">doneCb</span><span class="p">,</span> <span class="nx">options</span><span class="p">,</span>
        <span class="nx">errorCb</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">flag</span><span class="p">;</span></pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-46" id="section-46">&#182;</a>
</div>
<p>Open file for read.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>        <span class="nx">flag</span> <span class="o">=</span> <span class="nx">options</span><span class="p">.</span><span class="nx">flag</span> <span class="o">||</span> <span class="s1">&#39;w&#39;</span><span class="p">;</span>
        <span class="nx">fs</span><span class="p">.</span><span class="nx">open</span><span class="p">(</span><span class="nx">filename</span><span class="p">,</span> <span class="nx">flag</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">fd</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
                <span class="nx">errorCb</span><span class="p">(</span><span class="nx">err</span><span class="p">);</span>
            <span class="p">}</span>
            <span class="k">else</span> <span class="p">{</span>
                <span class="k">try</span> <span class="p">{</span>
                    <span class="nx">processFileStreamOutSync</span><span class="p">(</span><span class="nx">fd</span><span class="p">,</span> <span class="nx">lineCreatorCb</span><span class="p">,</span>  <span class="nx">options</span><span class="p">);</span>
                    <span class="k">if</span> <span class="p">(</span><span class="nx">doneCb</span><span class="p">)</span> <span class="nx">doneCb</span><span class="p">();</span>
                <span class="p">}</span>
                <span class="k">catch</span> <span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
                    <span class="nx">errorCb</span><span class="p">(</span><span class="nx">e</span><span class="p">);</span>
                <span class="p">}</span>
            <span class="p">}</span>
        <span class="p">});</span>
    <span class="p">}</span></pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs"><div class="dox">
  <div class="summary">
<div class="pilwrap" id="streamingwritesync">
  <h3>
    <a href="#streamingwritesync" class="pilcrow">&#182;</a>
    streamingWriteSync
  </h3>
</div>

  </div>
  <div class="body"><p>Gets lines from callback and streams them to file</p>
  </div>
  <div class="details">
    <div class="dox_tag_title">Params</div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name">filename.</span>
      <span class="dox_type">string</span>
      <span>Name of the file to which to write</span>
    </div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name">lineCreatorCb.</span>
      <span class="dox_type">function</span>
      <span>Callback to forward to
  <code>processFileStreamOutSync</code></span>
    </div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name">doneCb.</span>
      <span class="dox_type">function</span>
      <span>Callback to be executed upon completion</span>
    </div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name">options.</span>
      <span class="dox_type">object</span>
      <span>May contain property <code>flag</code> forwarded to
  <code>fs.open</code> (default: 'w'). All options are forwarded to
  <code>processFileStreamOutSync</code>.</span>
    </div>
    <div class="dox_tag_title">See</div>
    <div class="dox_tag_detail">
      <span class="dox_type">`fs.open`</span>
    </div>
    <div class="dox_tag_title">See</div>
    <div class="dox_tag_detail">
      <span class="dox_type">`processFileStreamOutSync`
  </span>
    </div>
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre>     <span class="kd">function</span> <span class="nx">streamingWriteSync</span><span class="p">(</span><span class="nx">filename</span><span class="p">,</span> <span class="nx">lineCreatorCb</span><span class="p">,</span> <span class="nx">doneCb</span><span class="p">,</span> <span class="nx">options</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">fd</span><span class="p">,</span> <span class="nx">flag</span><span class="p">;</span></pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-48" id="section-48">&#182;</a>
</div>
<p>Open file.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>        <span class="nx">flag</span> <span class="o">=</span> <span class="nx">options</span><span class="p">.</span><span class="nx">flag</span> <span class="o">||</span> <span class="s1">&#39;w&#39;</span><span class="p">;</span>
        <span class="nx">fd</span> <span class="o">=</span> <span class="nx">fs</span><span class="p">.</span><span class="nx">openSync</span><span class="p">(</span><span class="nx">filename</span><span class="p">,</span> <span class="nx">flag</span><span class="p">);</span>
        <span class="nx">processFileStreamOutSync</span><span class="p">(</span><span class="nx">fd</span><span class="p">,</span> <span class="nx">lineCreatorCb</span><span class="p">,</span> <span class="nx">options</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">doneCb</span><span class="p">)</span> <span class="nx">doneCb</span><span class="p">();</span>
    <span class="p">}</span></pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs"><div class="dox">
  <div class="summary">
<div class="pilwrap" id="processfilestreaminsync">
  <h3>
    <a href="#processfilestreaminsync" class="pilcrow">&#182;</a>
    processFileStreamInSync
  </h3>
</div>

  </div>
  <div class="body"><p>Reads from file and applies callback for each line.</p>

<p>Reads file part by part into buffer, applies callback to each line in
  file ignoring escaped line breaks. Streaming the contents of the file
  in via fixed size buffer and applying processing directly should be
  advantageous for large files since it avoids building large strings
  in memory for processing. To avoid overhead from multiple calls to
  <code>fs.readSync</code> consider increasing <code>options.bufferSize</code>.</p>
  </div>
  <div class="details">
    <div class="dox_tag_title">Params</div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name">fd.</span>
      <span class="dox_type">integer</span>
      <span>File descriptor of file to read</span>
    </div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name">lineProcessorCb.</span>
      <span class="dox_type">function</span>
      <span>Callback applied for each line in
  file. Accepts string as input argument.</span>
    </div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name">options.</span>
      <span class="dox_type">object</span>
      <span>Options object. If typeof options is string,
  it is treated as options = {encoding: options}

Available options and defaults:

<div class='highlight'><pre><code language=''>{

 encoding: undefined,        // Forwarded as `encoding` to
                             //`Buffer.write` and `Buffer.toString`

 bufferSize: 4 * 1024,       // Number of bytes to write out at once

 escapeCharacter: "\\"       // Symbol to indicate that subsequent
                             // character is escaped

 lineBreak: "\n"             // Sequence of characters to denote end of
                             // line

}
</code></pre></div></span>
    </div>
    <div class="dox_tag_title">See</div>
    <div class="dox_tag_detail">
      <span class="dox_type">`Buffer`
  </span>
    </div>
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre></pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-50" id="section-50">&#182;</a>
</div>
<p>adapted from <a href='http://stackoverflow.com/a/21219407'>http://stackoverflow.com/a/21219407</a></p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>    <span class="kd">function</span> <span class="nx">processFileStreamInSync</span><span class="p">(</span><span class="nx">fd</span><span class="p">,</span> <span class="nx">lineProcessorCb</span><span class="p">,</span> <span class="nx">options</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">read</span><span class="p">,</span> <span class="nx">line</span><span class="p">,</span> <span class="nx">lineBegin</span><span class="p">,</span> <span class="nx">searchBegin</span><span class="p">,</span> <span class="nx">lineEnd</span><span class="p">;</span>
        <span class="kd">var</span> <span class="nx">buffer</span><span class="p">,</span> <span class="nx">bufferSize</span><span class="p">,</span> <span class="nx">escapeChar</span><span class="p">,</span> <span class="nx">workload</span><span class="p">;</span>
        <span class="kd">var</span> <span class="nx">encoding</span><span class="p">;</span>
        <span class="kd">var</span> <span class="nx">lineBreak</span><span class="p">;</span>

        <span class="k">if</span> <span class="p">(</span><span class="k">typeof</span> <span class="nx">options</span> <span class="o">===</span> <span class="s1">&#39;string&#39;</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">encoding</span> <span class="o">=</span> <span class="nx">options</span><span class="p">;</span>
            <span class="nx">options</span> <span class="o">=</span> <span class="p">{};</span>
        <span class="p">}</span>
        <span class="k">else</span> <span class="p">{</span>
            <span class="nx">options</span> <span class="o">=</span> <span class="nx">options</span> <span class="o">||</span> <span class="p">{};</span>
            <span class="nx">encoding</span> <span class="o">=</span> <span class="nx">options</span><span class="p">.</span><span class="nx">encoding</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="nx">bufferSize</span> <span class="o">=</span> <span class="nx">options</span><span class="p">.</span><span class="nx">bufferSize</span> <span class="o">||</span> <span class="mi">4</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">;</span>
        <span class="nx">escapeChar</span> <span class="o">=</span> <span class="nx">options</span><span class="p">.</span><span class="nx">escapeCharacter</span> <span class="o">||</span> <span class="s2">&quot;\\&quot;</span><span class="p">;</span>
        <span class="nx">lineBreak</span> <span class="o">=</span> <span class="nx">options</span><span class="p">.</span><span class="nx">lineBreak</span> <span class="o">||</span> <span class="s2">&quot;\n&quot;</span><span class="p">;</span>
        <span class="nx">buffer</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Buffer</span><span class="p">(</span><span class="nx">bufferSize</span><span class="p">);</span>
        <span class="nx">workload</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">;</span></pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-51" id="section-51">&#182;</a>
</div>
<p>While file not empty, read into buffer.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>        <span class="k">while</span> <span class="p">((</span><span class="nx">read</span> <span class="o">=</span> <span class="nx">fs</span><span class="p">.</span><span class="nx">readSync</span><span class="p">(</span><span class="nx">fd</span><span class="p">,</span> <span class="nx">buffer</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">bufferSize</span><span class="p">,</span> <span class="kc">null</span><span class="p">))</span> <span class="o">!==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span></pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-52" id="section-52">&#182;</a>
</div>
<p>Add content of buffer to workload.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>        <span class="nx">workload</span> <span class="o">+=</span> <span class="nx">buffer</span><span class="p">.</span><span class="nx">toString</span><span class="p">(</span><span class="nx">encoding</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">read</span><span class="p">);</span>
        <span class="nx">lineBegin</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="nx">searchBegin</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span></pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-53" id="section-53">&#182;</a>
</div>
<p>While not on last line of buffer, process lines.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>            <span class="k">while</span> <span class="p">((</span><span class="nx">lineEnd</span> <span class="o">=</span> <span class="nx">workload</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="nx">lineBreak</span><span class="p">,</span> <span class="nx">searchBegin</span><span class="p">))</span> <span class="o">!==</span>
                <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span></pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-54" id="section-54">&#182;</a>
</div>
<p>Do not break on escaped endline characters.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>                <span class="k">if</span> <span class="p">(</span><span class="nx">workload</span><span class="p">.</span><span class="nx">charAt</span><span class="p">(</span><span class="nx">lineEnd</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">===</span> <span class="nx">escapeChar</span><span class="p">)</span> <span class="p">{</span>
                    <span class="nx">searchBegin</span> <span class="o">=</span> <span class="nx">lineEnd</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
                    <span class="k">continue</span><span class="p">;</span>
                <span class="p">}</span>

                <span class="nx">line</span> <span class="o">=</span> <span class="nx">workload</span><span class="p">.</span><span class="nx">substring</span><span class="p">(</span><span class="nx">lineBegin</span><span class="p">,</span> <span class="nx">lineEnd</span><span class="p">);</span></pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-55" id="section-55">&#182;</a>
</div>
<p>Process line.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>                <span class="nx">lineProcessorCb</span><span class="p">(</span><span class="nx">line</span><span class="p">);</span></pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-56" id="section-56">&#182;</a>
</div>
<p>Advance to next line.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>                <span class="nx">lineBegin</span> <span class="o">=</span> <span class="nx">lineEnd</span> <span class="o">+</span> <span class="nx">lineBreak</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span>
                <span class="nx">searchBegin</span> <span class="o">=</span> <span class="nx">lineBegin</span><span class="p">;</span>
            <span class="p">}</span></pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-57" id="section-57">&#182;</a>
</div>
<p>Begin workload with leftover characters for next line.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>            <span class="nx">workload</span> <span class="o">=</span> <span class="nx">workload</span><span class="p">.</span><span class="nx">substring</span><span class="p">(</span><span class="nx">lineBegin</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span></pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs"><div class="dox">
  <div class="summary">
<div class="pilwrap" id="processfilestreamoutsync">
  <h3>
    <a href="#processfilestreamoutsync" class="pilcrow">&#182;</a>
    processFileStreamOutSync
  </h3>
</div>

  </div>
  <div class="body"><p>Gets lines from callback and streams them to open file</p>

<p>Writes buffer by buffer to file filling the buffer with values returned
  from a callback.  This might be advantageous for large files since it
  avoids building large strings in memory for write out and might even be
  used to generate the data on the fly in the callback. To avoid overhead
  from multiple calls to <code>fs.writeync</code> consider increasing
  <code>options.bufferSize</code>.</p>
  </div>
  <div class="details">
    <div class="dox_tag_title">Params</div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name">fd.</span>
      <span class="dox_type">integer</span>
      <span>File descriptor of file to read</span>
    </div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name">lineCreatorCb.</span>
      <span class="dox_type">function</span>
      <span>Callback which returns a string
 containing the next line to be written or false if no more lines
 are to follow.</span>
    </div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name">options.</span>
      <span class="dox_type">object</span>
      <span>Options object. If typeof options is string,
  it is treated as options = {encoding: options}

Available options and defaults:

<div class='highlight'><pre><code language=''>{

 encoding: undefined,          // Forwarded as `encoding` to
                               //`Buffer.write` and `Buffer.toString`

 bufferSize: 4 * 1024          // Number of bytes to write out at once

 lineBreak: "\n"             // Sequence of characters to denote end of
                             // line

}
</code></pre></div></span>
    </div>
    <div class="dox_tag_title">See</div>
    <div class="dox_tag_detail">
      <span class="dox_type">`Buffer`
  </span>
    </div>
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre>    <span class="kd">function</span> <span class="nx">processFileStreamOutSync</span><span class="p">(</span><span class="nx">fd</span><span class="p">,</span> <span class="nx">lineCreatorCb</span><span class="p">,</span> <span class="nx">options</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">workload</span><span class="p">,</span> <span class="nx">line</span><span class="p">;</span>
        <span class="kd">var</span> <span class="nx">buffer</span><span class="p">,</span> <span class="nx">bufferSize</span><span class="p">,</span> <span class="nx">encoding</span><span class="p">,</span> <span class="nx">usedBytes</span><span class="p">;</span>
        <span class="kd">var</span> <span class="nx">lineBreak</span><span class="p">;</span>

        <span class="k">if</span> <span class="p">(</span><span class="k">typeof</span> <span class="nx">options</span> <span class="o">===</span> <span class="s1">&#39;string&#39;</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">encoding</span> <span class="o">=</span> <span class="nx">options</span><span class="p">;</span>
            <span class="nx">options</span> <span class="o">=</span> <span class="p">{};</span>
        <span class="p">}</span>
        <span class="k">else</span> <span class="p">{</span>
            <span class="nx">options</span> <span class="o">=</span> <span class="nx">options</span> <span class="o">||</span> <span class="p">{};</span>
            <span class="nx">encoding</span> <span class="o">=</span> <span class="nx">options</span><span class="p">.</span><span class="nx">encoding</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="nx">lineBreak</span> <span class="o">=</span> <span class="nx">options</span><span class="p">.</span><span class="nx">lineBreak</span> <span class="o">||</span> <span class="s2">&quot;\n&quot;</span><span class="p">;</span>

        <span class="nx">bufferSize</span> <span class="o">=</span> <span class="nx">options</span><span class="p">.</span><span class="nx">bufferSize</span> <span class="o">||</span> <span class="mi">4</span><span class="o">*</span><span class="mi">1024</span><span class="p">;</span>
        <span class="nx">buffer</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Buffer</span><span class="p">(</span><span class="nx">bufferSize</span><span class="p">);</span>
        <span class="nx">workload</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">;</span>
        <span class="k">do</span> <span class="p">{</span></pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-59" id="section-59">&#182;</a>
</div>
<p>Fill workload (assumes short-circuit evaluation).</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>            <span class="k">while</span> <span class="p">(</span><span class="nx">Buffer</span><span class="p">.</span><span class="nx">byteLength</span><span class="p">(</span><span class="nx">workload</span><span class="p">)</span> <span class="o">&lt;</span> <span class="nx">bufferSize</span> <span class="o">&amp;&amp;</span>
                <span class="p">(</span><span class="nx">line</span> <span class="o">=</span> <span class="nx">lineCreatorCb</span><span class="p">()))</span> <span class="p">{</span>
                <span class="nx">workload</span> <span class="o">+=</span> <span class="nx">line</span> <span class="o">+</span> <span class="nx">lineBreak</span><span class="p">;</span>
            <span class="p">}</span></pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-60" id="section-60">&#182;</a>
</div>
<p>Fill buffer completely.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>            <span class="nx">usedBytes</span> <span class="o">=</span> <span class="nx">buffer</span><span class="p">.</span><span class="nx">write</span><span class="p">(</span><span class="nx">workload</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">encoding</span><span class="p">);</span></pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-61" id="section-61">&#182;</a>
</div>
<p>Write buffer to file.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>            <span class="nx">fs</span><span class="p">.</span><span class="nx">writeSync</span><span class="p">(</span><span class="nx">fd</span><span class="p">,</span> <span class="nx">buffer</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">usedBytes</span><span class="p">);</span></pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-62" id="section-62">&#182;</a>
</div>
<p>Compute leftover and put it into workload.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>            <span class="nx">workload</span> <span class="o">=</span> <span class="nx">workload</span><span class="p">.</span><span class="nx">substring</span><span class="p">(</span>
                <span class="nx">buffer</span><span class="p">.</span><span class="nx">toString</span><span class="p">(</span><span class="nx">encoding</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">usedBytes</span><span class="p">).</span><span class="nx">length</span> <span class="o">+</span> <span class="mi">1</span>
            <span class="p">);</span>

        <span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="nx">workload</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="nx">line</span> <span class="o">!==</span> <span class="kc">false</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">})();</span>
</pre></div>
        </td>
      </tr>
  </tbody>
</table>
  </div>
</body>
</html>
