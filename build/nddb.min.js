// vim: ts=4 sts=4 sw=4 expandtab
// -- kriskowal Kris Kowal Copyright (C) 2009-2011 MIT License
// -- tlrobinson Tom Robinson Copyright (C) 2009-2010 MIT License (Narwhal Project)
// -- dantman Daniel Friesen Copyright (C) 2010 XXX TODO License or CLA
// -- fschaefer Florian Schäfer Copyright (C) 2010 MIT License
// -- Gozala Irakli Gozalishvili Copyright (C) 2010 MIT License
// -- kitcambridge Kit Cambridge Copyright (C) 2011 MIT License
// -- kossnocorp Sasha Koss XXX TODO License or CLA
// -- bryanforbes Bryan Forbes XXX TODO License or CLA
// -- killdream Quildreen Motta XXX TODO License or CLA
// -- michaelficarra Michael Ficarra Copyright (C) 2011 3-clause BSD License
// -- sharkbrainguy Gerard Paapu Copyright (C) 2011 MIT License
// -- bbqsrc Brendan Molloy XXX TODO License or CLA
// -- iwyg XXX TODO License or CLA
// -- DomenicDenicola Domenic Denicola XXX TODO License or CLA
// -- xavierm02 Montillet Xavier XXX TODO License or CLA
// -- Raynos Raynos XXX TODO License or CLA
// -- samsonjs Sami Samhuri XXX TODO License or CLA
// -- rwldrn Rick Waldron XXX TODO License or CLA
// -- lexer Alexey Zakharov XXX TODO License or CLA
/*!
    Copyright (c) 2009, 280 North Inc. http://280north.com/
    MIT License. http://github.com/280north/narwhal/blob/master/README.md
*/// Module systems magic dance

(function(e){typeof define=="function"?define(e):e()})(function(){function h(e){try{return Object.defineProperty(e,"sentinel",{}),"sentinel"in e}catch(t){}}Function.prototype.bind||(Function.prototype.bind=function(t){var n=this;if(typeof n!="function")throw new TypeError;var i=r.call(arguments,1),s=function(){if(this instanceof s){var e=function(){};e.prototype=n.prototype;var o=new e,u=n.apply(o,i.concat(r.call(arguments)));return u!==null&&Object(u)===u?u:o}return n.apply(t,i.concat(r.call(arguments)))};return s});var e=Function.prototype.call,t=Array.prototype,n=Object.prototype,r=t.slice,i=e.bind(n.toString),s=e.bind(n.hasOwnProperty),o,u,a,f,l;if(l=s(n,"__defineGetter__"))o=e.bind(n.__defineGetter__),u=e.bind(n.__defineSetter__),a=e.bind(n.__lookupGetter__),f=e.bind(n.__lookupSetter__);Array.isArray||(Array.isArray=function(t){return i(t)=="[object Array]"}),Array.prototype.forEach||(Array.prototype.forEach=function(t){var n=A(this),r=arguments[1],s=0,o=n.length>>>0;if(i(t)!="[object Function]")throw new TypeError;while(s<o)s in n&&t.call(r,n[s],s,n),s++}),Array.prototype.map||(Array.prototype.map=function(t){var n=A(this),r=n.length>>>0,s=Array(r),o=arguments[1];if(i(t)!="[object Function]")throw new TypeError;for(var u=0;u<r;u++)u in n&&(s[u]=t.call(o,n[u],u,n));return s}),Array.prototype.filter||(Array.prototype.filter=function(t){var n=A(this),r=n.length>>>0,s=[],o=arguments[1];if(i(t)!="[object Function]")throw new TypeError;for(var u=0;u<r;u++)u in n&&t.call(o,n[u],u,n)&&s.push(n[u]);return s}),Array.prototype.every||(Array.prototype.every=function(t){var n=A(this),r=n.length>>>0,s=arguments[1];if(i(t)!="[object Function]")throw new TypeError;for(var o=0;o<r;o++)if(o in n&&!t.call(s,n[o],o,n))return!1;return!0}),Array.prototype.some||(Array.prototype.some=function(t){var n=A(this),r=n.length>>>0,s=arguments[1];if(i(t)!="[object Function]")throw new TypeError;for(var o=0;o<r;o++)if(o in n&&t.call(s,n[o],o,n))return!0;return!1}),Array.prototype.reduce||(Array.prototype.reduce=function(t){var n=A(this),r=n.length>>>0;if(i(t)!="[object Function]")throw new TypeError;if(!r&&arguments.length==1)throw new TypeError;var s=0,o;if(arguments.length>=2)o=arguments[1];else do{if(s in n){o=n[s++];break}if(++s>=r)throw new TypeError}while(!0);for(;s<r;s++)s in n&&(o=t.call(void 0,o,n[s],s,n));return o}),Array.prototype.reduceRight||(Array.prototype.reduceRight=function(t){var n=A(this),r=n.length>>>0;if(i(t)!="[object Function]")throw new TypeError;if(!r&&arguments.length==1)throw new TypeError;var s,o=r-1;if(arguments.length>=2)s=arguments[1];else do{if(o in n){s=n[o--];break}if(--o<0)throw new TypeError}while(!0);do o in this&&(s=t.call(void 0,s,n[o],o,n));while(o--);return s}),Array.prototype.indexOf||(Array.prototype.indexOf=function(t){var n=A(this),r=n.length>>>0;if(!r)return-1;var i=0;arguments.length>1&&(i=k(arguments[1])),i=i>=0?i:r-Math.abs(i);for(;i<r;i++)if(i in n&&n[i]===t)return i;return-1}),Array.prototype.lastIndexOf||(Array.prototype.lastIndexOf=function(t){var n=A(this),r=n.length>>>0;if(!r)return-1;var i=r-1;arguments.length>1&&(i=k(arguments[1])),i=i>=0?i:r-Math.abs(i);for(;i>=0;i--)if(i in n&&t===n[i])return i;return-1}),Object.getPrototypeOf||(Object.getPrototypeOf=function(t){return t.__proto__||(t.constructor?t.constructor.prototype:n)});if(!Object.getOwnPropertyDescriptor){var c="Object.getOwnPropertyDescriptor called on a non-object: ";Object.getOwnPropertyDescriptor=function(t,r){if(typeof t!="object"&&typeof t!="function"||t===null)throw new TypeError(c+t);if(!s(t,r))return;var i,o,u;i={enumerable:!0,configurable:!0};if(l){var h=t.__proto__;t.__proto__=n;var o=a(t,r),u=f(t,r);t.__proto__=h;if(o||u)return o&&(i.get=o),u&&(i.set=u),i}return i.value=t[r],i}}Object.getOwnPropertyNames||(Object.getOwnPropertyNames=function(t){return Object.keys(t)}),Object.create||(Object.create=function(t,n){var r;if(t===null)r={__proto__:null};else{if(typeof t!="object")throw new TypeError("typeof prototype["+typeof t+"] != 'object'");var i=function(){};i.prototype=t,r=new i,r.__proto__=t}return n!==void 0&&Object.defineProperties(r,n),r});if(Object.defineProperty){var p=h({}),d=typeof document=="undefined"||h(document.createElement("div"));if(!p||!d)var v=Object.defineProperty}if(!Object.defineProperty||v){var m="Property description must be an object: ",g="Object.defineProperty called on non-object: ",y="getters & setters can not be defined on this javascript engine";Object.defineProperty=function(t,r,i){if(typeof t!="object"&&typeof t!="function"||t===null)throw new TypeError(g+t);if(typeof i!="object"&&typeof i!="function"||i===null)throw new TypeError(m+i);if(v)try{return v.call(Object,t,r,i)}catch(c){}if(s(i,"value"))if(l&&(a(t,r)||f(t,r))){var h=t.__proto__;t.__proto__=n,delete t[r],t[r]=i.value,t.__proto__=h}else t[r]=i.value;else{if(!l)throw new TypeError(y);s(i,"get")&&o(t,r,i.get),s(i,"set")&&u(t,r,i.set)}return t}}Object.defineProperties||(Object.defineProperties=function(t,n){for(var r in n)s(n,r)&&Object.defineProperty(t,r,n[r]);return t}),Object.seal||(Object.seal=function(t){return t}),Object.freeze||(Object.freeze=function(t){return t});try{Object.freeze(function(){})}catch(b){Object.freeze=function(t){return function(n){return typeof n=="function"?n:t(n)}}(Object.freeze)}Object.preventExtensions||(Object.preventExtensions=function(t){return t}),Object.isSealed||(Object.isSealed=function(t){return!1}),Object.isFrozen||(Object.isFrozen=function(t){return!1}),Object.isExtensible||(Object.isExtensible=function(t){if(Object(t)===t)throw new TypeError;var n="";while(s(t,n))n+="?";t[n]=!0;var r=s(t,n);return delete t[n],r});if(!Object.keys){var w=!0,E=["toString","toLocaleString","valueOf","hasOwnProperty","isPrototypeOf","propertyIsEnumerable","constructor"],S=E.length;for(var x in{toString:null})w=!1;Object.keys=function O(e){if(typeof e!="object"&&typeof e!="function"||e===null)throw new TypeError("Object.keys called on a non-object");var O=[];for(var t in e)s(e,t)&&O.push(t);if(w)for(var n=0,r=S;n<r;n++){var i=E[n];s(e,i)&&O.push(i)}return O}}Date.prototype.toISOString||(Date.prototype.toISOString=function(){var t,n,r;if(!isFinite(this))throw new RangeError;t=[this.getUTCFullYear(),this.getUTCMonth()+1,this.getUTCDate(),this.getUTCHours(),this.getUTCMinutes(),this.getUTCSeconds()],n=t.length;while(n--)r=t[n],r<10&&(t[n]="0"+r);return t.slice(0,3).join("-")+"T"+t.slice(3).join(":")+"."+("000"+this.getUTCMilliseconds()).slice(-3)+"Z"}),Date.now||(Date.now=function(){return(new Date).getTime()}),Date.prototype.toJSON||(Date.prototype.toJSON=function(t){if(typeof this.toISOString!="function")throw new TypeError;return this.toISOString()}),isNaN(Date.parse("2011-06-15T21:40:05+06:00"))&&(Date=function(e){var t=function i(t,n,r,s,o,u,a){var f=arguments.length;if(this instanceof e){var l=f==1&&String(t)===t?new e(i.parse(t)):f>=7?new e(t,n,r,s,o,u,a):f>=6?new e(t,n,r,s,o,u):f>=5?new e(t,n,r,s,o):f>=4?new e(t,n,r,s):f>=3?new e(t,n,r):f>=2?new e(t,n):f>=1?new e(t):new e;return l.constructor=i,l}return e.apply(this,arguments)},n=new RegExp("^(\\d{4})(?:-(\\d{2})(?:-(\\d{2})(?:T(\\d{2}):(\\d{2})(?::(\\d{2})(?:\\.(\\d{3}))?)?(?:Z|(?:([-+])(\\d{2}):(\\d{2})))?)?)?)?$");for(var r in e)t[r]=e[r];return t.now=e.now,t.UTC=e.UTC,t.prototype=e.prototype,t.prototype.constructor=t,t.parse=function(r){var i=n.exec(r);if(i){i.shift();for(var s=1;s<7;s++)i[s]=+(i[s]||(s<3?1:0)),s==1&&i[s]--;var o=+i.pop(),u=+i.pop(),a=i.pop(),f=0;if(a){if(u>23||o>59)return NaN;f=(u*60+o)*6e4*(a=="+"?-1:1)}return e.UTC.apply(this,i)+f}return e.parse.apply(this,arguments)},t}(Date));var T="	\n\f\r   ᠎             　\u2028\u2029﻿";if(!String.prototype.trim||T.trim()){T="["+T+"]";var N=new RegExp("^"+T+T+"*"),C=new RegExp(T+T+"*$");String.prototype.trim=function(){return String(this).replace(N,"").replace(C,"")}}var k=function(e){return e=+e,e!==e?e=-1:e!==0&&e!==1/0&&e!==-1/0&&(e=(e>0||-1)*Math.floor(Math.abs(e))),e},L="a"[0]!="a",A=function(e){if(e==null)throw new TypeError;return L&&typeof e=="string"&&e?e.split(""):Object(e)}}),function(e){var t="0.3",n=e.store=function(e,t,r,i){r=r||{},i=r.type&&r.type in n.types?r.type:n.type;if(!i||!n.types[i]){n.log("Cannot save/load value. Invalid storage type selected: "+i,"ERR");return}return n.log("Accessing "+i+" storage"),n.types[i](e,t,r)};n.name="__shelf__",n.verbosity=0,n.types={};var r="volatile";try{Object.defineProperty(n,"type",{set:function(e){return"undefined"==typeof n.types[e]?(n.log("Cannot set store.type to an invalid type: "+e),!1):(r=e,e)},get:function(){return r},configurable:!1,enumerable:!0})}catch(i){n.type=r}n.addType=function(e,t){n.types[e]=t,n[e]=function(t,r,i){return i=i||{},i.type=e,n(t,r,i)};if(!n.type||n.type==="volatile")n.type=e},n.onquotaerror=undefined,n.error=function(){console.log("shelf quota exceeded"),"function"==typeof n.onquotaerror&&n.onquotaerror(null)},n.log=function(e){n.verbosity>0&&console.log("Shelf v."+t+": "+e)},n.isPersistent=function(){return n.types?n.type==="volatile"?!1:!0:!1};try{Object.defineProperty(n,"persistent",{set:function(){},get:n.isPersistent,configurable:!1})}catch(i){n.persistent=!1}n.decycle=function(e){return JSON&&JSON.decycle&&"function"==typeof JSON.decycle&&(e=JSON.decycle(e)),e},n.retrocycle=function(e){return JSON&&JSON.retrocycle&&"function"==typeof JSON.retrocycle&&(e=JSON.retrocycle(e)),e},n.stringify=function(e){if(!JSON||!JSON.stringify||"function"!=typeof JSON.stringify)throw new Error("JSON.stringify not found. Received non-string value and could not serialize.");return e=n.decycle(e),JSON.stringify(e)},n.parse=function(e){if("undefined"==typeof e)return undefined;if(JSON&&JSON.parse&&"function"==typeof JSON.parse)try{e=JSON.parse(e)}catch(t){n.log("Error while parsing a value: "+t,"ERR"),n.log(e)}return e=n.retrocycle(e),e},function(){function r(e){return n.parse(n.stringify(e))}var e={},t={};n.addType("volatile",function(n,i,s){return n?i===undefined?r(e[n]):(t[n]&&(clearTimeout(t[n]),delete t[n]),i===null?(delete e[n],null):(e[n]=i,s.expires&&(t[n]=setTimeout(function(){delete e[n],delete t[n]},s.expires)),i)):r(e)})}()}("undefined"!=typeof module&&"undefined"!=typeof module.exports?module.exports:this),function(e){function r(e,n){t.addType(e,function(r,i,s){var o,u,a,f,l=i,c=(new Date).getTime();if(!r){l={},f=[],a=0;try{r=n.length;while(r=n.key(a++))rprefix.test(r)&&(u=JSON.parse(n.getItem(r)),u.expires&&u.expires<=c?f.push(r):l[r.replace(rprefix,"")]=u.data);while(r=f.pop())n.removeItem(r)}catch(h){}return l}r="__amplify__"+r;if(i===undefined){o=n.getItem(r),u=o?JSON.parse(o):{expires:-1};if(!(u.expires&&u.expires<=c))return u.data;n.removeItem(r)}else if(i===null)n.removeItem(r);else{u=t.stringify({data:i,expires:s.expires?c+s.expires:null});try{n.setItem(r,u)}catch(h){t[e]();try{n.setItem(r,u)}catch(h){throw t.error()}}}return l})}var t=e.store;if(!t){console.log("amplify.shelf.js: shelf.js core not found. Amplify storage not available.");return}if("undefined"==typeof window){console.log("amplify.shelf.js: am I running in a browser? Amplify storage not available.");return}var n=new RegExp("^"+t.name);for(var i in{localStorage:1,sessionStorage:1})try{window[i].setItem("__amplify__","x"),window[i].removeItem("__amplify__"),r(i,window[i])}catch(s){}if(!t.types.localStorage&&window.globalStorage)try{r("globalStorage",window.globalStorage[window.location.hostname]),t.type==="sessionStorage"&&(t.type="globalStorage")}catch(s){}(function(){if(t.types.localStorage)return;var e=document.createElement("div"),n="amplify";e.style.display="none",document.getElementsByTagName("head")[0].appendChild(e);try{e.addBehavior("#default#userdata"),e.load(n)}catch(r){e.parentNode.removeChild(e);return}t.addType("userData",function(r,i,s){e.load(n);var o,u,a,f,l,c=i,h=(new Date).getTime();if(!r){c={},l=[],f=0;while(o=e.XMLDocument.documentElement.attributes[f++])u=JSON.parse(o.value),u.expires&&u.expires<=h?l.push(o.name):c[o.name]=u.data;while(r=l.pop())e.removeAttribute(r);return e.save(n),c}r=r.replace(/[^\-._0-9A-Za-z\xb7\xc0-\xd6\xd8-\xf6\xf8-\u037d\u037f-\u1fff\u200c-\u200d\u203f\u2040\u2070-\u218f]/g,"-"),r=r.replace(/^-/,"_-");if(i===undefined){o=e.getAttribute(r),u=o?JSON.parse(o):{expires:-1};if(!(u.expires&&u.expires<=h))return u.data;e.removeAttribute(r)}else i===null?e.removeAttribute(r):(a=e.getAttribute(r),u=t.stringify({data:i,expires:s.expires?h+s.expires:null}),e.setAttribute(r,u));try{e.save(n)}catch(p){a===null?e.removeAttribute(r):e.setAttribute(r,a),t.userData();try{e.setAttribute(r,u),e.save(n)}catch(p){throw a===null?e.removeAttribute(r):e.setAttribute(r,a),t.error()}}return c})})()}(this),function(e){var t=e.JSUS={};t._classes={},"undefined"==typeof console&&(console={}),"undefined"==typeof console.log&&(console.log=function(){}),t.log=function(e){console.log(e)},t.extend=function(e,n){var r,i;if("object"!=typeof e&&"function"!=typeof e)return n;"undefined"==typeof n&&(n=n||this,"function"==typeof e?(r=e.toString(),r=r.substr("function ".length),r=r.substr(0,r.indexOf("("))):r=e.constructor||e.__proto__.constructor,r&&(this._classes[r]=e));for(i in e)e.hasOwnProperty(i)&&(typeof n[i]!="object"?n[i]=e[i]:t.extend(e[i],n[i]));return e.prototype&&t.extend(e.prototype,n.prototype||n),n},t.require=t.get=function(e){return"undefined"==typeof t.clone?(t.log("JSUS.clone not found. Cannot continue."),!1):"undefined"==typeof e?t.clone(t._classes):"undefined"==typeof t._classes[e]?(t.log("Could not find class "+e),!1):t.clone(t._classes[e])},t.isNodeJS=function(){return"undefined"!=typeof module&&"undefined"!=typeof module.exports&&"function"==typeof require},t.isNodeJS()&&(require("./lib/compatibility"),require("./lib/obj"),require("./lib/array"),require("./lib/time"),require("./lib/eval"),require("./lib/dom"),require("./lib/random"),require("./lib/parse"),require("./lib/queue"),require("./lib/fs"))}("undefined"!=typeof module&&"undefined"!=typeof module.exports?module.exports:window),function(JSUS){function COMPATIBILITY(){}COMPATIBILITY.compatibility=function(){var support={};try{Object.defineProperty({},"a",{enumerable:!1,value:1}),support.defineProperty=!0}catch(e){support.defineProperty=!1}try{eval("({ get x(){ return 1 } }).x === 1"),support.setter=!0}catch(err){support.setter=!1}try{var value;eval("({ set x(v){ value = v; } }).x = 1"),support.getter=!0}catch(err){support.getter=!1}return support},JSUS.extend(COMPATIBILITY)}("undefined"!=typeof JSUS?JSUS:module.parent.exports.JSUS),function(e){function t(){}Array.prototype.filter||(Array.prototype.filter=function(e){"use strict";if(this===void 0||this===null)throw new TypeError;var t=Object(this),n=t.length>>>0;if(typeof e!="function")throw new TypeError;var r=[],i=arguments[1];for(var s=0;s<n;s++)if(s in t){var o=t[s];e.call(i,o,s,t)&&r.push(o)}return r}),t.isArray=function(e){return e?Object.prototype.toString.call(e)==="[object Array]":!1},t.seq=function(t,n,r,i){var s;if("number"!=typeof t)return!1;if(t===Infinity)return!1;if("number"!=typeof n)return!1;if(n===Infinity)return!1;if(t===n)return[t];if(r===0)return!1;if(!e.in_array(typeof r,["undefined","number"]))return!1;r=r||1,i=i||function(e){return e},s=t,out=[];if(t<n)while(s<=n)out.push(i(s)),s+=r;else while(s>=n)out.push(i(s)),s-=r;return out},t.each=function(e,t,n){if("object"!=typeof e)return!1;if(!t)return!1;n=n||this;var r,i=e.length;for(r=0;r<i;r++)t.call(n,e[r]);return!0},t.map=function(){if(arguments.length<2)return;var n=Array.prototype.slice.call(arguments),r=n.shift(),i=n[0];if(!t.isArray(r)){e.log("ARRAY.map() the first argument must be an array. Found: "+r);return}var s=[],o;for(var u=0;u<r.length;u++)n[0]=r[u],o=i.apply(this,n),"undefined"!=typeof o&&s.push(o);return s},t.removeElement=function(t,n){var r,i;if("undefined"==typeof t||!n)return!1;"object"==typeof t?r=e.equals:r=function(e,t){return e===t};for(i=0;i<n.length;i++)if(r(t,n[i]))return n.splice(i,1);return!1},t.inArray=t.in_array=function(t,n){var r,i,s;if(!n)return!1;r=e.equals,s=n.length;for(i=0;i<s;i++)if(r.call(this,t,n[i]))return!0;return!1},t.getNGroups=function(e,n){return t.getGroupsSizeN(e,Math.floor(e.length/n))},t.getGroupsSizeN=function(e,t){var n=e.slice(0),r=n.length,i=n.length,s=[],o,u,a=[],f=0;for(o=0;o<i;o++)u=Math.floor(Math.random()*r),f>=t&&(s.push(a),f=0,a=[]),a.push(n[u]),n.splice(u,1),r=n.length,f++;return a.length>0&&s.push(a),s},t._latinSquare=function(t,n,r){r="undefined"==typeof r?!0:r;if(t===n&&!r)return!1;var i=[],s=[];for(var o=0;o<t;o++)i[o]=o;var u=null,a=0,f=t,l=[];r||(f=t-1);for(o=0;o<n;o++){do u=e.randomInt(a,f);while(e.in_array(u,l));l.push(u),u==1?(s[o]=i.slice(u),s[o].push(0)):s[o]=i.slice(u).concat(i.slice(0,u))}return s},t.latinSquare=function(e,n){return n||(n=e),!e||e<0||n<0?!1:(n>e&&(n=e),t._latinSquare(e,n,!0))},t.latinSquareNoSelf=function(e,n){return n||(n=e-1),!e||e<0||n<0?!1:(n>e&&(n=e-1),t._latinSquare(e,n,!1))},t.generateCombinations=function(t,n){function s(e,t){var n=[];for(var r=0;r<e.length;r++)n.push(t[e[r]]);return n}var r,i,o=t.length,u=[];for(r=0;r<n;r++)u.push(r);var a=[];for(r=o-n;r<o;r++)a.push(r);while(!e.equals(u,a)){callback(s(u,t)),r=n-1;while(u[r]==o-n+r)r-=1;u[r]+=1;for(i=r+1;i<n;i++)u[i]=u[r]+i-r}return s(u,t)},t.matchN=function(e,n,r){var i,s,o,u;if(!e)return;if(!n)return e;i=[],len=e.length,found=[];for(s=0;s<len;s++)o=e.slice(0),o.splice(s,1),r&&(o=t.arrayDiff(o,found)),u=t.getNRandom(o,n),found=found.concat(u),u.splice(0,0,e[s]),i.push(u),u=[];return i},t.rep=function(t,n){var r,i;if(!t)return;if(!n)return t.slice(0);if(n<1){e.log("times must be greater or equal 1","ERR");return}r=1,i=t.slice(0);for(;r<n;r++)i=i.concat(t);return i},t.stretch=function(n,r){var i,s,o,u;if(!n)return;if(!r)return n.slice(0);if("number"==typeof r){if(r<1){e.log("times must be greater or equal 1","ERR");return}r=t.rep([r],n.length)}i=[];for(s=0;s<n.length;s++){o=r[s%r.length];for(u=0;u<o;u++)i.push(n[s])}return i},t.arrayIntersect=function(t,n){return t.filter(function(t){return e.in_array(t,n)})},t.arrayDiff=function(t,n){return t.filter(function(t){return!e.in_array(t,n)})},t.shuffle=function(e){var t,n,r,i,s;if(!e)return;t=Array.prototype.slice.call(e),n=e.length-1;for(s=n;s>0;s--)r=Math.floor(Math.random()*(s+1)),i=t[r],t[r]=t[s],t[s]=i;return t},t.getNRandom=function(e,n){return t.shuffle(e).slice(0,n)},t.distinct=function(e){var n=[];return e?(t.each(e,function(e){t.in_array(e,n)||n.push(e)}),n):n},t.transpose=function(e){if(!e)return;var n,r,i,s,o=[];n=e.length||0,r=t.isArray(e[0])?e[0].length:0;if(n===0||r===0)return o;for(i=0;i<r;i++){o[i]=[];for(s=0;s<n;s++)o[i][s]=e[s][i]}return o},e.extend(t)}("undefined"!=typeof JSUS?JSUS:module.parent.exports.JSUS),function(e){function t(){}var n=null;"undefined"!=typeof e.compatibility&&(n=e.compatibility()),t.equals=function(e,n){var r,i,s,o;r=typeof e,i=typeof n;if(r!==i)return!1;if("undefined"===r||"undefined"===i)return e===n;if(e===null||n===null)return e===n;if("number"===r&&isNaN(e)&&"number"===i&&isNaN(n))return isNaN(e)&&isNaN(n);s={number:"",string:"","boolean":""};if(r in s)return e===n;if("function"===r)return e.toString()===n.toString();for(o in e)if(e.hasOwnProperty(o)){if("undefined"==typeof n[o]&&"undefined"!=typeof e[o])return!1;if(!n[o]&&e[o])return!1;switch(typeof e[o]){case"function":if(e[o].toString()!==n[o].toString())return!1;default:if(!t.equals(e[o],n[o]))return!1}}for(o in n)if(n.hasOwnProperty(o)){if("undefined"==typeof e[o]&&"undefined"!=typeof n[o])return!1;if(!e[o]&&n[o])return!1}return!0},t.isEmpty=function(e){var t;if("undefined"==typeof e)return!0;for(t in e)if(e.hasOwnProperty(t))return!1;return!0},t.size=t.getListSize=function(e){var t,n;if(!e)return 0;if("number"==typeof e)return 0;if("string"==typeof e)return 0;t=0;for(n in e)e.hasOwnProperty(n)&&t++;return t},t._obj2Array=function(e,n,r,i){var s,o;if("object"!=typeof e)return[e];if(r){i="undefined"!=typeof i?i:1;if(i>r)return[e];i+=1}s=[];for(o in e)e.hasOwnProperty(o)&&(n&&s.push(o),"object"==typeof e[o]?s=s.concat(t._obj2Array(e[o],n,r,i)):s.push(e[o]));return s},t.obj2Array=function(e,n){return t._obj2Array(e,!1,n)},t.obj2KeyedArray=t.obj2KeyArray=function(e,n){return t._obj2Array(e,!0,n)},t.obj2QueryString=function(e){var t,n;if("object"!=typeof e)throw new TypeError("JSUS.objectToQueryString: obj must be object.");t=[];for(n in e)e.hasOwnProperty(n)&&t.push(encodeURIComponent(n)+"="+encodeURIComponent(e[n]));return"?"+t.join("&")},t.keys=t.objGetAllKeys=function(e,n,r){var i,s;if(!e)return[];n="number"==typeof n&&n>=0?n:0,r="number"==typeof r&&r>=0?r:0,i=[];for(s in e)e.hasOwnProperty(s)&&(i.push(s),r<n&&"object"==typeof e[s]&&(i=i.concat(t.objGetAllKeys(e[s],r+1))));return i},t.implode=t.implodeObj=function(e){var t,n,r;if(!e)return[];t=[];for(n in e)e.hasOwnProperty(n)&&(r={},r[n]=e[n],t.push(r));return t},t.clone=function(e){var r,i,s;if(!e)return e;if("number"==typeof e)return e;if("string"==typeof e)return e;if("boolean"==typeof e)return e;"function"==typeof e?r=function(){return e.apply(r,arguments)}:r=Object.prototype.toString.call(e)==="[object Array]"?[]:{};for(i in e){e[i]&&"object"==typeof e[i]?Object.prototype.toString.call(e[i])==="[object Array]"?s=e[i].slice(0):s=t.clone(e[i]):s=e[i];if(e.hasOwnProperty(i))r[i]=s;else if(n&&n.defineProperty)Object.defineProperty(r,i,{value:s,writable:!0,configurable:!0});else try{Object.defineProperty(r,i,{value:s,writable:!0,configurable:!0})}catch(o){r[i]=s}}return r},t.join=function(e,n){var r,i;r=t.clone(e);if(!n)return r;for(i in r)r.hasOwnProperty(i)&&"undefined"!=typeof n[i]&&("object"==typeof n[i]?r[i]=t.join(r[i],n[i]):r[i]=n[i]);return r},t.merge=function(e,n){var r,i;if(!e&&!n)return!1;if(!e)return t.clone(n);if(!n)return t.clone(e);r=t.clone(e);for(i in n)n.hasOwnProperty(i)&&(n[i]&&"object"==typeof n[i]?("object"!=typeof r[i]&&(Object.prototype.toString.call(n[i])==="[object Array]"?r[i]=[]:r[i]={}),r[i]=t.merge(r[i],n[i])):r[i]=n[i]);return r},t.mixin=function(e,t){var n;if(!e&&!t)return;if(!e)return t;if(!t)return e;for(n in t)e[n]=t[n]},t.mixout=function(e,t){var n;if(!e&&!t)return;if(!e)return t;if(!t)return e;for(n in t)"undefined"==typeof e[n]&&(e[n]=t[n])},t.mixcommon=function(e,t){var n;if(!e&&!t)return;if(!e)return t;if(!t)return e;for(n in t)"undefined"!=typeof e[n]&&(e[n]=t[n])},t.mergeOnKey=function(e,n,r){var i,s;i=t.clone(e);if(!n||!r)return i;for(s in n)if(n.hasOwnProperty(s)){if(!i[s]||"object"!=typeof i[s])i[s]={};i[s][r]=n[s]}return i},t.subobj=function(e,n){var r,i,s;if(!e)return!1;r={};if(!n)return r;n instanceof Array||(n=[n]);for(i=0;i<n.length;i++)s=n[i],e.hasOwnProperty(s)?r[s]=e[s]:t.hasOwnNestedProperty(s,e)&&t.setNestedValue(s,t.getNestedValue(s,e),r);return r},t.skim=function(e,n){var r,i;if(!e)return!1;r=t.clone(e);if(!n)return r;n instanceof Array||(n=[n]);for(i=0;i<n.length;i++)r.hasOwnProperty(i)?delete r[i]:t.deleteNestedKey(n[i],r);return r},t.setNestedValue=function(n,r,i){var s,o;return n?(i="object"==typeof i?i:{},s=n.split("."),s.length===1?(i[n]=r,i):(o=s.shift(),i[o]=t.setNestedValue(s.join("."),r,i[o]),i)):(e.log("Cannot set value of undefined property","ERR"),!1)},t.getNestedValue=function(e,n){var r,i;if(!n)return;return r=e.split("."),r.length===1?n[e]:(i=r.shift(),t.getNestedValue(r.join("."),n[i]))},t.deleteNestedKey=function(e,n){var r,i;if(!n)return;return r=e.split("."),r.length===1?(delete n[e],!0):(i=r.shift(),"undefined"==typeof n[i]?!1:t.deleteNestedKey(r.join("."),n[i]))},t.hasOwnNestedProperty=function(e,n){var r,i;return n?(r=e.split("."),r.length===1?n.hasOwnProperty(e):(i=r.shift(),t.hasOwnNestedProperty(r.join("."),n[i]))):!1},t.split=function(t,n){var r,i,s;if(!t)return;return!n||"object"!=typeof t[n]?e.clone(t):(r=[],i=e.clone(t),i[n]={},s=function(t){var o,u;for(o in t)u=e.clone(i),t.hasOwnProperty(o)&&("object"==typeof t[o]?r=r.concat(s(t[o])):(u[n][o]=t[o],r.push(u)));return r},s(t[n]))},t.melt=function(e,t){var n={},r=t.length;for(var i=0;i<e.length;i++)n[e[i]]=t[i%r];return n},t.uniqueKey=function(t,n,r){var i,s=1;if(!t){e.log("Cannot find unique name in undefined object","ERR");return}n=""+(n||Math.floor(Math.random()*1e15)),r=r||1e6,i=n;while(t[i]){i=n+s,s++;if(s>r)return}return i},t.augment=function(e,n,r){var i,s;r=r||t.keys(e);for(i=0;i<r.length;i++)s=r[i],"undefined"!=typeof e[s]&&Object.prototype.toString.call(e[s])!=="[object Array]"&&(e[s]=[e[s]]),"undefined"!==n[s]&&(e[s]||(e[s]=[]),e[s].push(n[s]))},t.pairwiseWalk=function(e,t,n){var r,i;if(!e&&!t)return;if(!e)return t;if(!t)return e;i={};for(r in e)e.hasOwnProperty(r)&&(i[r]=t.hasOwnProperty(r)?n(e[r],t[r]):n(e[r]));for(r in t)t.hasOwnProperty(r)&&"undefined"==typeof i[r]&&(i[r]=n(undefined,t[r]));return i},e.extend(t)}("undefined"!=typeof JSUS?JSUS:module.parent.exports.JSUS),function(e){function t(){}t.stringify_prefix="!?_",t.marker_func=t.stringify_prefix+"function",t.marker_null=t.stringify_prefix+"null",t.marker_und=t.stringify_prefix+"undefined",t.marker_nan=t.stringify_prefix+"NaN",t.marker_inf=t.stringify_prefix+"Infinity",t.marker_minus_inf=t.stringify_prefix+"-Infinity",t.getQueryString=function(e,t){var n;if(t&&"string"!=typeof t)throw new TypeError("JSUS.getQueryString: referer must be string or undefined.");return t=t||window.location.search,"undefined"==typeof e?t:(e=e.replace(/[\[]/,"\\[").replace(/[\]]/,"\\]"),n=new RegExp("[\\?&]"+e+"=([^&#]*)"),results=n.exec(t),results===null?!1:decodeURIComponent(results[1].replace(/\+/g," ")))},t.tokenize=function(t,n,r){var i,s;if(!t)return;return!n||!n.length?[t]:(r=r||{},i="[",e.each(n,function(e){e===" "&&(e="\\s"),i+=e}),i+="]+",s=new RegExp(i),t.split(s,r.limit))},t.stringify=function(e,n){return JSON.stringify(e,function(e,n){var r=typeof n;return"function"===r?t.stringify_prefix+n.toString():"undefined"===r?t.marker_und:n===null?t.marker_null:"number"===r&&isNaN(n)?t.marker_nan:n===Number.POSITIVE_INFINITY?t.marker_inf:n===Number.NEGATIVE_INFINITY?t.marker_minus_inf:n},n)},t.stringifyAll=function(e,n){for(var r in e)e.hasOwnProperty(r)||("object"==typeof e[r]?e[r]=t.stringifyAll(e[r]):e[r]=e[r]);return t.stringify(e)},t.parse=function(n){function c(e){if("object"!=typeof e)return h(e);for(var t in e)e.hasOwnProperty(t)&&("object"==typeof e[t]?c(e[t]):e[t]=h(e[t]));return e}function h(n){var l=typeof n;if(l==="string"){if(n.substring(0,r)!==t.stringify_prefix)return n;if(n.substring(0,i)===t.marker_func)return e.eval(n.substring(r));if(n.substring(0,s)===t.marker_null)return null;if(n.substring(0,o)===t.marker_und)return undefined;if(n.substring(0,u)===t.marker_nan)return NaN;if(n.substring(0,a)===t.marker_inf)return Infinity;if(n.substring(0,f)===t.marker_minus_inf)return-Infinity}return n}var r=t.stringify_prefix.length,i=t.marker_func.length,s=t.marker_null.length,o=t.marker_und.length,u=t.marker_nan.length,a=t.marker_inf.length,f=t.marker_minus_inf.length,l=JSON.parse(n);return c(l)},e.extend(t)}("undefined"!=typeof JSUS?JSUS:module.parent.exports.JSUS),function(e,t,n){function r(e,n){var r;r=this,e=e||{},t||this.throwErr("Error","constructor","JSUS not found"),this.nddbid=new m("nddbid",this),this.db=[],this.lastSelection=[],this.hashtray=new v,this.tags={},this.hooks={insert:[],remove:[],update:[]},this.nddb_pointer=0,this.query=new p,this.addDefaultFilters(),this.__C={},this.__H={},this.__I={},this.__V={},this.__update={},this.__update.pointer=!1,this.__update.indexes=!1,this.__update.sort=!1,this.__shared={},this.log=console.log,this.globalCompare=function(e,t){return-1},this.comparator("*",function(e,t,n,i){var s,o,u;for(s in e){o=r.getComparator(s),t[s]=t["*"],u=o(e,t);if(u===n)return u;if("undefined"!==i&&u===i)return u}return n===0?i===1?-1:1:n===1?i===0?-1:0:i===0?1:0}),this.init(e),n&&this.importDB(n)}function s(e,n){var r;"object"!=typeof e&&"function"!=typeof e&&this.throwErr("TypeError","insert","object or function expected "+typeof e+" received."),"undefined"==typeof e._nddbid&&(r=t.uniqueKey(this.nddbid.resolve),r||this.throwErr("Error","insert","failed to create index: "+e),Object.defineProperty?Object.defineProperty(e,"_nddbid",{value:r}):e._nddbid=r),this.nddbid.resolve[e._nddbid]=this.db.length,this.db.push(e),this.emit("insert",e),n&&(this._indexIt(e,this.db.length-1),this._hashIt(e),this._viewIt(e))}function o(e,t,n,r){var i,s;throw i="(?)",s=this._getConstrName()+"._analyzeQuery: "+e+". Malformed query: "+t||i+" "+n||i+" "+r||i+".",new Error(s)}function u(e,n){return t.obj2Array(e,1)}function a(e,n){return t.obj2KeyedArray(e,1)}function f(e,n){var r=t.getNestedValue(n,e);if("undefined"!=typeof r)return t.obj2Array(r,1)}function l(e,n){var r=t.subobj(e,n);if(!t.isEmpty(r))return t.obj2Array(r,1)}function c(e,n){var r=t.getNestedValue(n,e);if("undefined"!=typeof r)return n.split(".").concat(t.obj2KeyedArray(r))}function h(e,n){var r=t.subobj(e,n);if(!t.isEmpty(r))return t.obj2KeyedArray(r)}function p(){this.reset()}function d(e){return e.cb}function v(){this.resolve={}}function m(e,t){this.idx=e,this.nddb=t,this.resolve={}}e.NDDB=r,r.decycle=function(e){return JSON&&JSON.decycle&&"function"==typeof JSON.decycle&&(e=JSON.decycle(e)),e},r.retrocycle=function(e){return JSON&&JSON.retrocycle&&"function"==typeof JSON.retrocycle&&(e=JSON.retrocycle(e)),e},r.prototype.addFilter=function(e,t){this.filters[e]=t},r.prototype.addDefaultFilters=function(){function n(e,t,n,r){var i;return RegExp.escape=function(e){return e.replace(/([.*+?^=!:${}()|[\]\/\\])/g,"\\$1")},i=RegExp.escape(t),i=i.replace(/%/g,".*").replace(/_/g,"."),i=new RegExp("^"+i+"$",r),"object"==typeof e?function(t){var n,r;r=e.length;for(n=0;n<r;n++)if("undefined"!=typeof t[e[n]]&&i.test(t[e[n]]))return t}:e==="*"?function(e){var t;for(t in e)if("undefined"!=typeof e[t]&&i.test(e[t]))return e}:function(t){if("undefined"!=typeof t[e]&&i.test(t[e]))return t}}this.filters||(this.filters={});var e;e=this,this.filters.E=function(n,r,i){return"object"==typeof n?function(n){var i,s;for(i in n){s=e.getComparator(i),r[i]=r[0]["*"];if(s(n,r,1)>0){r[i]=r[1]["*"];if(s(n,r,-1)<0)return n}}if("undefined"!=typeof n[i])return n;if("undefined"!=typeof t.getNestedValue(i,n))return n}:function(e){if("undefined"!=typeof e[n])return e;if("undefined"!=typeof t.getNestedValue(n,e))return e}},this.filters["=="]=function(e,t,n){return function(e){if(n(e,t,0)===0)return e}},this.filters["!="]=function(e,t,n){return function(e){if(n(e,t,0)!==0)return e}},this.filters[">"]=function(e,t,n){return"object"==typeof e||e==="*"?function(e){if(n(e,t,1)===1)return e}:function(r){if("undefined"==typeof r[e])return;if(n(r,t,1)===1)return r}},this.filters[">="]=function(e,t,n){return"object"==typeof e||e==="*"?function(e){var r=n(e,t,0,1);if(r===1||r===0)return e}:function(r){if("undefined"==typeof r[e])return;var i=n(r,t,0,1);if(i===1||i===0)return r}},this.filters["<"]=function(e,t,n){return"object"==typeof e||e==="*"?function(e){if(n(e,t,-1)===-1)return e}:function(r){if("undefined"==typeof r[e])return;if(n(r,t,-1)===-1)return r}},this.filters["<="]=function(e,t,n){return"object"==typeof e||e==="*"?function(e){var r=n(e,t,0,-1);if(r===-1||r===0)return e}:function(r){if("undefined"==typeof r[e])return;var i=n(r,t,0,-1);if(i===-1||i===0)return r}},this.filters["><"]=function(t,n,r){return"object"==typeof t?function(e){var i,s;s=t.length;for(i=0;i<s;i++)if(r(e,n[0],1)>0&&r(e,n[1],-1)<0)return e}:t==="*"?function(t){var r,i;for(r in t){i=e.getComparator(r),n[r]=n[0]["*"];if(i(t,n,1)>0){n[r]=n[1]["*"];if(i(t,n,-1)<0)return t}}}:function(e){if(r(e,n[0],1)>0&&r(e,n[1],-1)<0)return e}},this.filters["<>"]=function(e,t,n){return"object"==typeof e||e==="*"?function(e){if(n(e,t[0],-1)<0||n(e,t[1],1)>0)return e}:function(r){if("undefined"==typeof r[e])return;if(n(r,t[0],-1)<0||n(r,t[1],1)>0)return r}},this.filters["in"]=function(e,t,n){return"object"==typeof e?function(e){var r,i;i=t.length;for(r=0;r<i;r++)if(n(e,t[r],0)===0)return e}:function(r){var i,s,o;s={},o=t.length;for(i=0;i<o;i++){s[e]=t[i];if(n(r,s,0)===0)return r}}},this.filters["!in"]=function(e,t,n){return"object"==typeof e?function(e){var r,i;i=t.length;for(r=0;r<i;r++)if(n(e,t[r],0)===0)return;return e}:function(r){var i,s,o;s={},o=t.length;for(i=0;i<o;i++){s[e]=t[i];if(n(r,s,0)===0)return}return r}},this.filters.LIKE=function(t,r,i){return n(t,r,i)},this.filters.iLIKE=function(t,r,i){return n(t,r,i,"i")}},r.prototype.throwErr=function(e,t,n){var r,i;throw n=n||"generic error",r=this._getConstrName(),t&&(r=r+"."+t),r=r+": "+n+".",e==="TypeError"?new TypeError(r):new Error(errMg)},r.prototype.init=function(e){var t,n,r,i;e=e||{},this.__options=e,e.tags&&("object"!=typeof e.tags&&(i="options.tag must be object or undefined",this.throwErr("TypeError","init",i)),this.tags=e.tags),"undefined"!=typeof e.nddb_pointer&&("number"!=typeof e.nddb_pointer&&(i="options.nddb_pointer must be number or undefined",this.throwErr("TypeError","init",i)),this.nddb_pointer=e.nddb_pointer),e.hooks&&("object"!=typeof e.hooks&&(i="options.hooks must be object or undefined",this.throwErr("TypeError","init",i)),this.hooks=e.hooks),e.globalCompare&&("function"!=typeof e.globalCompare&&(i="options.globalCompare must be function or undefined",this.throwErr("TypeError","init",i)),this.globalCompare=e.globalCompare),e.update&&("object"!=typeof e.update&&(i="options.update must be object or undefined",this.throwErr("TypeError","init",i)),"undefined"!=typeof e.update.pointer&&(this.__update.pointer=e.update.pointer),"undefined"!=typeof e.update.indexes&&(this.__update.indexes=e.update.indexes),"undefined"!=typeof e.update.sort&&(this.__update.sort=e.update.sort));if("object"==typeof e.filters){"object"!=typeof e.filters&&(i="options.filters must be object or undefined",this.throwErr("TypeError","init",i));for(t in e.filters)this.addFilter(t,e.filters[t])}if("object"==typeof e.shared)for(n in e.shared)e.shared.hasOwnProperty(n)&&(this.__shared[n]=e.shared[n]);delete this.__options.shared,e.log&&this.initLog(e.log,e.logCtx),e.C&&("object"!=typeof e.C&&(i="options.C must be object or undefined",this.throwErr("TypeError","init",i)),this.__C=e.C);if(e.H){"object"!=typeof e.H&&(i="options.H must be object or undefined",this.throwErr("TypeError","init",i));for(r in e.H)e.H.hasOwnProperty(r)&&this.hash(r,e.H[r])}if(e.I){"object"!=typeof e.I&&(i="options.I must be object or undefined",this.throwErr("TypeError","init",i)),this.__I=e.I;for(r in e.I)e.I.hasOwnProperty(r)&&this.index(r,e.I[r])}if(e.V){"object"!=typeof e.V&&(i="options.V must be object or undefined",this.throwErr("TypeError","init",i)),this.__V=e.V;for(r in e.V)e.V.hasOwnProperty(r)&&this.view(r,e.V[r])}},r.prototype.initLog=function(e,t){"function"!=typeof e&&this.throwErr("TypeError","initLog","cb must be function"),t=t||this,"function"!=typeof t&&"object"!=typeof t&&this.throwErr("TypeError","initLog","ctx must be object or function"),this.log=function(){return e.apply(t,arguments)}},r.prototype._getConstrName=function(){return this.constructor&&this.constructor.name?this.constructor.name:"NDDB"},r.prototype._autoUpdate=function(e){var n=e?t.merge(this.__update,e):this.__update;n.pointer&&(this.nddb_pointer=this.db.length-1),n.sort&&this.sort(),n.indexes&&this.rebuildIndexes()},r.prototype.importDB=function(e){var n;t.isArray(e)||this.throwErr("TypeError","importDB","db must be array");for(n=0;n<e.length;n++)s.call(this,e[n],this.__update.indexes);this._autoUpdate({indexes:!1})},r.prototype.insert=function(e){s.call(this,e,this.__update.indexes),this._autoUpdate({indexes:!1})},r.prototype.size=function(){return this.db.length},r.prototype.breed=function(e){return e&&!t.isArray(e)&&this.throwErr("TypeError","importDB","db must be array or undefined"),new this.constructor(this.cloneSettings(),e||this.fetch())},r.prototype.cloneSettings=function(e){var n,r,i,s,o;r=this.__options||{},i=!0,r.H=this.__H,r.I=this.__I,r.C=this.__C,r.V=this.__V,r.tags=this.tags,r.update=this.__update,r.hooks=this.hooks,r.globalCompare=this.globalCompare,r.log&&(s=r.log,delete r.log),r.logCtx&&(o=r.logCtx,delete r.logCtx),r=t.clone(r);for(n in e)if(e.hasOwnProperty(n)){if(n==="shared"){i=!1;continue}delete r[n]}return i&&(r.shared=this.__shared),s&&(r.log=s,this.__options.log=s),o&&(r.logCtx=o,this.__options.logCtx=o),r},r.prototype.toString=function(){var e,t;e="";for(t=0;t<this.db.length;t++)e+=this.db[t]+"\n";return e},r.prototype.stringify=function(e){var n,i;return this.size()?(e="undefined"==typeof e?!0:e,n=e?0:4,i="[",this.each(function(e){e=r.decycle(e),i+=t.stringify(e,n)+", "}),i=i.replace(/, $/,"]"),i):"[]"},r.prototype.comparator=function(e,t){"string"!=typeof e&&this.throwErr("TypeError","comparator","d must be string"),"function"!=typeof t&&this.throwErr("TypeError","comparator","comparator must be function"),this.__C[e]=t},r.prototype.c=r.prototype.comparator,r.prototype.getComparator=function(e){var n,r,s;if("string"==typeof e)"undefined"!=typeof this.__C[e]?r=this.__C[e]:r=function(r,i){var s,o;return"undefined"==typeof r&&"undefined"==typeof i?0:"undefined"==typeof r?1:"undefined"==typeof i?-1:("undefined"!=typeof r[e]?s=r[e]:e.lastIndexOf(".")!==-1&&(s=t.getNestedValue(e,r)),"undefined"!=typeof i[e]?o=i[e]:e.lastIndexOf(".")!==-1&&(o=t.getNestedValue(e,i)),"undefined"==typeof s&&"undefined"==typeof o?0:"undefined"==typeof s?1:"undefined"==typeof o?-1:s>o?1:o>s?-1:o===s?0:1)};else{s={},n=e.length;for(i=0;i<n;i++)s[e[i]]=this.getComparator(e[i]);r=function(e,t,n,r){var i,o,u;for(i in s)if(s.hasOwnProperty(i)){if("undefined"==typeof e[i])continue;u={},u[i]=t,o=s[i](e,u);if(o===n)return o;if("undefined"!==r&&o===r)return o}return n===0?r===1?-1:1:n===1?r===0?-1:0:r===0?1:0}}return r},r.prototype.isReservedWord=function(e){return this[e]?!0:!1},r.prototype.index=function(e,t){"string"!=typeof e&&"number"!=typeof e&&this.throwErr("TypeError","index","idx must be string or number"),this.isReservedWord(e)&&this.throwErr("TypeError","index","idx is reserved word: "+e),"function"!=typeof t&&this.throwErr("TypeError","index","func must be function"),this.__I[e]=t,this[e]=new m(e,this)},r.prototype.i=r.prototype.index,r.prototype.view=function(e,t){var n;"string"!=typeof e&&"number"!=typeof e&&this.throwErr("TypeError","view","idx must be string or number"),this.isReservedWord(e)&&this.throwErr("TypeError","view","idx is reserved word: "+e),"function"!=typeof t&&this.throwErr("TypeError","view","func must be function"),n=this.cloneSettings({V:""}),this.__V[e]=t,this[e]=new r(n)},r.prototype.hash=function(e,t){"string"!=typeof e&&"number"!=typeof e&&this.throwErr("TypeError","hash","idx must be string or number"),this.isReservedWord(e)&&this.throwErr("TypeError","hash","idx is reserved word: "+e),"function"!=typeof t&&this.throwErr("TypeError","hash","func must be function"),this.__H[e]=t,this[e]={}},r.prototype.h=r.prototype.hash,r.prototype.resetIndexes=function(e){var n,r;r=e||t.merge({h:!0,v:!0,i:!0},e);if(r.h)for(n in this.__H)this.__H.hasOwnProperty(n)&&(this[n]={});if(r.v)for(n in this.__V)this.__V.hasOwnProperty(n)&&(this[n]=new this.constructor);if(r.i)for(n in this.__I)this.__I.hasOwnProperty(n)&&(this[n]=new m(n,this))},r.prototype.rebuildIndexes=function(){var e=!t.isEmpty(this.__H),n=!t.isEmpty(this.__I),r=!t.isEmpty(this.__V),i,s;if(!e&&!n&&!r)return;e&&!n&&!r?i=this._hashIt:!e&&n&&!r?i=this._indexIt:!e&&!n&&r?i=this._viewIt:e&&n&&!r?i=function(e,t){this._hashIt(e),this._indexIt(e,t)}:!e&&n&&r?i=function(e,t){this._indexIt(e,t),this._viewIt(e)}:e&&!n&&r?i=function(e,t){this._hashIt(e),this._viewIt(e)}:i=function(e,t){this._indexIt(e,t),this._hashIt(e),this._viewIt(e)},this.resetIndexes({h:e,v:r,i:n});for(s=0;s<this.db.length;s++)i.call(this,this.db[s],s)},r.prototype._indexIt=function(e,n,r){var i,s,o,u;if(!e||t.isEmpty(this.__I))return;for(u in this.__I)this.__I.hasOwnProperty(u)&&(i=this.__I[u],o=i(e),o!==r&&"undefined"!=typeof r&&"undefined"!=typeof this[u].resolve[r]&&delete this[u].resolve[r],"undefined"!=typeof o&&(this[u]||(this[u]=new m(u,this)),this[u]._add(o,n)))},r.prototype._viewIt=function(e){var n,i,s,o,u;if(!e||t.isEmpty(this.__V))return!1;for(o in this.__V)if(this.__V.hasOwnProperty(o)){n=this.__V[o],s=n(e);if("undefined"==typeof s){if(!this[o])continue;"undefined"!=typeof this[o].nddbid.resolve[e._nddbid]&&this[o].nddbid.remove(e._nddbid);continue}this[o]||(u=this.cloneSettings({V:""}),this[o]=new r(u)),this[o].insert(e)}},r.prototype._hashIt=function(e){var n,i,s,o,u,a;if(!e||t.isEmpty(this.__H))return!1;for(o in this.__H)if(this.__H.hasOwnProperty(o)){n=this.__H[o],s=n(e);if("undefined"==typeof s){a=this.hashtray.get(o,e._nddbid),a&&(this[o][a].nddbid.remove(e._nddbid),this.hashtray.remove(o,e._nddbid));continue}this[o]||(this[o]={}),this[o][s]||(u=this.cloneSettings({H:""}),this[o][s]=new r(u)),this[o][s].insert(e),this.hashtray.set(o,e._nddbid,s)}},r.prototype.on=function(e,t){"string"!=typeof e&&this.throwErr("TypeError","on","event must be string"),"function"!=typeof t&&this.throwErr("TypeError","on","func must be function"),this.hooks[e]||this.throwErr("TypeError","on","unknown event: "+e),this.hooks[e].push(t)},r.prototype.off=function(e,t){var n;"string"!=typeof e&&this.throwErr("TypeError","off","event must be string"),t&&"function"!=typeof t&&this.throwErr("TypeError","off","func must be function or undefined"),this.hooks[e]||this.throwErr("TypeError","off","unknown event: "+e);if(!this.hooks[e].length)return!1;if(!t)return this.hooks[e]=[],!0;for(n=0;n<this.hooks[e].length;n++)if(this.hooks[e][n]==t)return this.hooks[e].splice(n,1),!0;return!1},r.prototype.emit=function(){var e,t;t=Array.prototype.splice.call(arguments,0,1),"string"!=typeof t[0]&&this.throwErr("TypeError","emit","first argument must be string");if(!this.hooks[t]||!this.hooks[t].length)return;for(e=0;e<this.hooks[t].length;e++)this.hooks[t][e].apply(this,arguments)},r.prototype._analyzeQuery=function(e,n,r){var i,s,u,a;"undefined"==typeof e&&o.call(this,"undefined dimension",e,n,r);if("undefined"!=typeof n){n==="="?n="==":n==="!=="&&(n="!="),n in this.filters||o.call(this,"unknown operator "+n,e,n,r);if(t.in_array(n,["><","<>","in","!in"])){r instanceof Array||(a="range-queries need an array as third parameter",o.call(this,a,e,n,r));if(n==="<>"||n==="><")t.isArray(e)||(r[0]=t.setNestedValue(e,r[0]),r[1]=t.setNestedValue(e,r[1]))}else if(t.in_array(n,["!=",">","==",">=","<","<="])){"undefined"==typeof r&&(a="value cannot be undefined in comparison queries",o.call(this,a,e,n,r));if(t.isArray(e)){s=e.length;for(i=0;i<s;i++)t.setNestedValue(e[i],r)}else r=t.setNestedValue(e,r)}}else"undefined"!=typeof r?(a="undefined filter and defined value",o.call(this,a,e,n,r)):(n="E",r="");return{d:e,op:n,value:r}},r.prototype.distinct=function(){return this.breed(t.distinct(this.db))},r.prototype.select=function(e,t,n){return this.query.reset(),arguments.length?this.and(e,t,n):this},r.prototype.and=function(e,t,n){var r,i;return r=this._analyzeQuery(e,t,n),i=this.filters[r.op](r.d,r.value,this.getComparator(r.d)),this.query.addCondition("AND",i),this},r.prototype.or=function(e,t,n){var r,i;return r=this._analyzeQuery(e,t,n),i=this.filters[r.op](r.d,r.value,this.getComparator(r.d)),this.query.addCondition("OR",i),this},r.prototype.selexec=function(e,t,n){return this.select(e,t,n).execute()},r.prototype.execute=function(){return this.filter(this.query.get.call(this.query))},r.prototype.exists=function(e){var n,r,i;"object"!=typeof e&&"function"!=typeof e&&this.throwErr("TypeError","exists","o must be object or function"),i=this.fetch(),r=i.length;for(n=0;n<i.length;n++)if(t.equals(i[n],e))return!0;return!1},r.prototype.limit=function(e){var t;return"number"!=typeof e&&this.throwErr("TypeError","exists","limit must be number"),t=this.fetch(),e!==0&&(t=e>0?t.slice(0,e):t.slice(e)),this.breed(t)},r.prototype.reverse=function(){return this.db.reverse(),this},r.prototype.sort=function(e){var t,n;return e?"function"==typeof e?t=e:e instanceof Array?(n=this,t=function(t,r){var i,s;for(i=0;i<e.length;i++){s=n.getComparator(e[i]).call(n,t,r);if(s!==0)return s}return s}):t=this.getComparator(e):t=this.globalCompare,this.db.sort(t),this},r.prototype.shuffle=function(e){var n;return n=t.shuffle(this.db),e&&(this.db=n,this.rebuildIndexes()),this.breed(n)},r.prototype.filter=function(e){return this.breed(this.fetch().filter(e))},r.prototype.each=r.prototype.forEach=function(){var e,t,n,r;e=arguments[0],"function"!=typeof e&&this.throwErr("TypeError","each","first argument must be function"),n=this.fetch(),r=n.length;for(t=0;t<r;t++)arguments[0]=n[t],e.apply(this,arguments)},r.prototype.map=function(){var e,t,n,r,i,s;e=arguments[0],"function"!=typeof e&&this.throwErr("TypeError","map","first argument must be function"),n=this.fetch(),r=n.length,i=[];for(t=0;t<n.length;t++)arguments[0]=n[t],s=e.apply(this,arguments),"undefined"!=typeof s&&i.push(s);return i},r.prototype.update=function(e){var n,r,i;"object"!=typeof e&&this.throwErr("TypeError","update","update must be object"),i=this.fetch();if(i.length){r=i.length;for(n=0;n<r;n++)this.emit("update",i[n],e),t.mixin(i[n],e),this._indexIt(i[n]),this._hashIt(i[n]),this._viewIt(i[n]);this._autoUpdate({indexes:!1})}return this},r.prototype.removeAllEntries=function(){return this.db.length?(this.emit("remove",this.db),this.nddbid.resolve={},this.db=[],this._autoUpdate(),this):this},r.prototype.clear=function(e){var t;if(e){this.db=[],this.nddbid.resolve={},this.tags={},this.query.reset(),this.nddb_pointer=0,this.lastSelection=[],this.hashtray.clear();for(t in this.__H)this[t]&&delete this[t];for(t in this.__C)this[t]&&delete this[t];for(t in this.__I)this[t]&&delete this[t]}else this.log("Do you really want to clear the current dataset? Please use clear(true)","WARN");return e},r.prototype.join=function(e,n,r,i){return this._join(e,n,t.equals,r,i)},r.prototype.concat=function(e,t,n,r){return this._join(e,t,function(){return!0},n,r)},r.prototype._join=function(e,n,r,i,s){var o,u,a,f,l,c,h,p;if(!e||!n)return this.breed([]);r=r||t.equals,i="undefined"!=typeof i?i:"joined",s&&(s=s instanceof Array?s:[s]),o=[],u=[];for(l=0;l<this.db.length;l++){a=t.getNestedValue(e,this.db[l]);if("undefined"!=typeof a)for(c=l+1;c<this.db.length;c++)f=t.getNestedValue(n,this.db[c]),"undefined"!=typeof f&&r(a,f)&&(h=t.clone(this.db[l]),p=s?t.subobj(this.db[c],s):this.db[c],h[i]=p,o.push(h))}return this.breed(o)},r.prototype.split=function(e){var n,r,i,s;"string"!=typeof e&&this.throwErr("TypeError","split","key must be string"),i=this.fetch(),s=i.length,n=[];for(r=0;r<s;r++)n=n.concat(t.split(i[r],e));return this.breed(n)},r.prototype.fetch=function(e){var t;return this.db.length&&this.query.query.length?(e&&"boolean"!=typeof e&&this.throwErr("TypeError","fetch","doNotReset must be undefined or boolean."),t=this.db.filter(this.query.get.call(this.query)),e||this.query.reset()):t=this.db,this.lastSelection=t,t},r.prototype.fetchSubObj=function(e){var n,r,i,s;if(!e)return[];i=this.fetch(),s=[];for(n=0;n<i.length;n++)r=t.subobj(i[n],e),t.isEmpty(r)||s.push(r);return s},r.prototype.fetchValues=function(e){var n,r,i,s,o;n=this.fetch(),o=typeof e,s={};if(o==="undefined")for(i=0;i<n.length;i++)t.augment(s,n[i],t.keys(n[i]));else if(o==="string"){s[e]=[];for(i=0;i<n.length;i++)r=t.getNestedValue(e,n[i]),"undefined"!=typeof r&&s[e].push(r)}else if(t.isArray(e)){s=t.melt(e,t.rep([],e.length));for(i=0;i<n.length;i++)r=t.subobj(n[i],e),t.isEmpty(r)||t.augment(s,r)}return s},r.prototype._fetchArray=function(e,t){var n,r,i,s,o;t?e?"string"==typeof e?r=c:r=h:r=a:e?"string"==typeof e?r=f:r=l:r=u,n=this.fetch(),i=[];for(o=0;o<n.length;o++)s=r.call(n[o],n[o],e),"undefined"!=typeof s&&i.push(s);return i},r.prototype.fetchArray=function(e){return this._fetchArray(e)},r.prototype.fetchKeyArray=function(e){return this._fetchArray(e,!0)},r.prototype.groupBy=function(e){var n,r,i,s,o;db=this.fetch();if(!e)return db;n=[],r=[];for(i=0;i<db.length;i++){s=t.getNestedValue(e,db[i]);if("undefined"==typeof s)continue;t.in_array(s,n)||(n.push(s),o=this.filter(function(n){if(t.equals(t.getNestedValue(e,n),s))return this}),o.nddb_pointer=0,r.push(o))}return r},r.prototype.count=function(e){var n,r,i,s;s=this.fetch(),i=s.length;if("undefined"==typeof e)return i;"string"!=typeof e&&this.throwErr("TypeError","count","key must be string or undefined"),r=0;for(n=0;n<i;n++)t.hasOwnNestedProperty(e,s[n])&&r++;return r},r.prototype.sum=function(e){var n,r,i,s,o;"string"!=typeof e&&this.throwErr("TypeError","sum","key must be string"),o=this.fetch(),i=o.length,n=NaN;for(r=0;r<i;r++)s=t.getNestedValue(e,o[r]),isNaN(s)||(isNaN(n)&&(n=0),n+=s);return n},r.prototype.mean=function(e){var n,r,i,s,o,u;"string"!=typeof e&&this.throwErr("TypeError","mean","key must be string"),s=this.fetch(),u=s.length,n=0,r=0;for(o=0;o<u;o++)i=t.getNestedValue(e,s[o]),isNaN(i)||(n+=i,r++);return r===0?NaN:n/r},r.prototype.stddev=function(e){var n,r,i,s,o,u,a;"string"!=typeof e&&this.throwErr("TypeError","stddev","key must be string"),i=this.fetch(),o=i.length;if(!o||o===1)return NaN;s=-1,u=0,a=0,n=0;for(;++s<o;)r=t.getNestedValue(e,i[s]),isNaN(r)||(n++,u+=r,a+=Math.pow(r,2));return r=a-Math.pow(u,2)/n,Math.sqrt(r/(n-1))},r.prototype.min=function(e){var n,r,i,s,o;"string"!=typeof e&&this.throwErr("TypeError","min","key must be string"),i=this.fetch(),o=i.length,n=NaN;for(s=0;s<o;s++)r=t.getNestedValue(e,i[s]),!isNaN(r)&&(r<n||isNaN(n))&&(n=r);return n},r.prototype.max=function(e){var n,r,i,s,o;"string"!=typeof e&&this.throwErr("TypeError","max","key must be string"),o=this.fetch(),i=o.length,n=NaN;for(r=0;r<i;r++)s=t.getNestedValue(e,o[r]),!isNaN(s)&&(s>n||isNaN(n))&&(n=s);return n},r.prototype.skim=function(e){return"string"!=typeof e&&!t.isArray(e)&&this.throwErr("TypeError","skim","skim must be string or array"),this.breed(this.map(function(n){var r=t.skim(n,e);if(!t.isEmpty(r))return r}))},r.prototype.keep=function(e){return"string"!=typeof e&&!t.isArray(e)&&this.throwErr("TypeError","keep","keep must be string or array"),this.breed(this.map(function(n){var r=t.subobj(n,e);if(!t.isEmpty(r))return r}))},r.prototype.diff=function(e){return t.isArray(e)||(("object"!=typeof e||!t.isArray(e.db))&&this.throwErr("TypeError","diff","nddb must be array or NDDB"),e=e.db),e.length?this.breed(t.arrayDiff(this.fetch(),e)):this.breed([])},r.prototype.intersect=function(e){return t.isArray(e)||(("object"!=typeof e||!t.isArray(e.db))&&this.throwErr("TypeError","intersect","nddb must be array or NDDB"),e=e.db),e.length?this.breed(t.arrayIntersect(this.fetch(),e)):this.breed([])},r.prototype.get=function(e){return"number"!=typeof e&&this.throwErr("TypeError","get","pos must be number"),this.db[e]},r.prototype.current=function(){return this.db[this.nddb_pointer]},r.prototype.next=function(){var e;return this.nddb_pointer++,e=r.prototype.current.call(this),e||this.nddb_pointer--,e},r.prototype.previous=function(){var e;return this.nddb_pointer--,e=r.prototype.current.call(this),e||this.nddb_pointer++,e},r.prototype.first=function(e){var t=this.fetch();return t.length?(e||(this.nddb_pointer=0),t[0]):undefined},r.prototype.last=function(e){var t=this.fetch();return t.length?(e||(this.nddb_pointer=t.length-1),t[t.length-1]):undefined},r.prototype.tag=function(e,t){var n,r;return"string"!=typeof e&&"number"!=typeof e&&this.throwErr("TypeError","tag","tag must be string or number"),n=null,r=typeof t,r==="undefined"?n=this.db[this.nddb_pointer]:r==="number"?((t>this.length||t<0)&&this.throwErr("Error","tag","invalid index provided: "+t),n=this.db[t]):n=t,this.tags[e]=n,n},r.prototype.resolveTag=function(e){return"string"!=typeof e&&this.throwErr("TypeError","resolveTag","tag must be string"),this.tags[e]},r.prototype.storageAvailable=function(){return"function"==typeof n},r.prototype.save=function(e,t,r){"string"!=typeof e&&this.throwErr("TypeError","save","file must be string"),r=r||!1,this.storageAvailable()||this.throwErr("Error","save","no persistent storage available"),n(e,this.stringify(r)),t&&t()},r.prototype.load=function(e,i,s){var o,u;"string"!=typeof e&&this.throwErr("TypeError","load","file must be string"),this.storageAvailable()||this.throwErr("Error","load","no persistent storage found"),o=n(e);if("undefined"==typeof o)return;"string"==typeof o&&(o=t.parse(o)),t.isArray(o)||this.throwErr("Error","load","expects to load an array");for(u=0;u<o.length;u++)o[u]=r.retrocycle(o[u]);this.importDB(o)},p.prototype.addCondition=function(e,t){this.query[this.pointer].push({type:e,cb:t})},p.prototype.addBreak=function(){this.pointer++,this.query[this.pointer]=[]},p.prototype.reset=function(){this.query=[],this.pointer=0,this.query[this.pointer]=[]},p.prototype.get=function(){var e,t,n,r,i,s,o,u,a=this.query,f=this.pointer,l=this.operators;if(f===0){e=a[f],t=e.length;if(t===1)return d(e[0]);if(t===2){n=d(e[0]),r=d(e[1]),s=e[1].type;switch(s){case"OR":return function(e){if("undefined"!=typeof n(e))return e;if("undefined"!=typeof r(e))return e};case"AND":return function(e){if("undefined"!=typeof n(e)&&"undefined"!=typeof r(e))return e};case"NOT":return function(e){if("undefined"!=typeof n(e)&&"undefined"==typeof r(e))return e}}}else{if(t!==3)return function(n){var r,i,s,o,u="OR",a=!0;for(r=t-1;r>-1;r--){i=d(e[r]),s=e[r].type,o="undefined"!=typeof i(n);if(s==="OR"){if(o)return n}else if(s==="AND"){if(!o)return;if(u==="OR"&&!a)return}u=s,a=s==="AND"?o:o||a}return n};n=d(e[0]),r=d(e[1]),i=d(e[2]),s=e[1].type,o=e[2].type,s=s+"_"+o;switch(s){case"OR_OR":return function(e){if("undefined"!=typeof n(e))return e;if("undefined"!=typeof r(e))return e;if("undefined"!=typeof i(e))return e};case"OR_AND":return function(e){if("undefined"==typeof i(e))return;if("undefined"!=typeof r(e))return e;if("undefined"!=typeof n(e))return e};case"AND_OR":return function(e){if("undefined"!=typeof i(e))return e;if("undefined"==typeof r(e))return;if("undefined"!=typeof n(e))return e};case"AND_AND":return function(e){if("undefined"==typeof i(e))return;if("undefined"==typeof r(e))return;if("undefined"!=typeof n(e))return e}}}}},v.prototype.set=function(e,t,n){this.resolve[e+"_"+t]=n},v.prototype.get=function(e,t){return this.resolve[e+"_"+t]},v.prototype.remove=function(e,t){delete this.resolve[e+"_"+t]},v.prototype.clear=function(){this.resolve={}},m.prototype._add=function(e,t){this.resolve[e]=t},m.prototype._remove=function(e){delete this.resolve[e]},m.prototype.size=function(){return t.size(this.resolve)},m.prototype.get=function(e){return"undefined"==typeof this.resolve[e]?!1:this.nddb.db[this.resolve[e]]},m.prototype.remove=function(e){var t,n;n=this.resolve[e];if("undefined"==typeof n)return!1;t=this.nddb.db[n];if("undefined"==typeof t)return;return this.nddb.db.splice(n,1),delete this.resolve[e],this.nddb.emit("remove",t),this.nddb._autoUpdate(),t},m.prototype.pop=m.prototype.remove,m.prototype.update=function(e,n){var r,i,s;return i=this.resolve[e],"undefined"==typeof i?!1:(s=this.nddb,r=s.db[i],s.emit("update",r,n),t.mixin(r,n),s.__update.indexes&&(s._indexIt(r,i,e),s._hashIt(r),s._viewIt(r)),s._autoUpdate({indexes:!1}),r)},m.prototype.getAllKeys=function(){return t.keys(this.resolve)},m.prototype.getAllKeyElements=function(){var e={},t;for(t in this.resolve)this.resolve.hasOwnProperty(t)&&(e[t]=this.nddb.db[this.resolve[t]]);return e}}("undefined"!=typeof module&&"undefined"!=typeof module.exports?module.exports:window,"undefined"!=typeof module&&"undefined"!=typeof module.exports?module.parent.exports.JSUS||require("JSUS").JSUS:JSUS,"object"==typeof module&&"function"==typeof require?module.parent.exports.store||require("shelf.js/build/shelf-fs.js").store:this.store)